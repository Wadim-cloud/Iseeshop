import"./CWj6FrbW.js";import"./69_IOA4Y.js";import{a1 as _e,p as ge,A as o,G as U,o as be,an as Y,ar as c,ap as d,as as i,x as s,ao as L,a as he,w as Z,ax as we}from"./9BOlcS-b.js";import{s as k,e as y,r as ye}from"./BsZz1DC-.js";import{i as M}from"./WEOj8Vpi.js";import{e as Ce}from"./DhNq3B23.js";import{t as f,a as p}from"./Bnw62dMu.js";import{b as xe}from"./9x1-h8O0.js";import{s as Ue}from"./Bfc47y5P.js";import{i as ke}from"./xvq0-Hdq.js";import{p as R}from"./Cmn9WjR9.js";import{a as Me,s as Ee}from"./BR43cs2B.js";import{s as ee}from"./BeMxMaC5.js";import{u as De}from"./yrXH0Tcs.js";import{A as Ie}from"./CM5gJEXl.js";function Ae(P,v){var r;var g=(r=P.$$events)==null?void 0:r[v.type],S=_e(g)?g.slice():g==null?[]:[g];for(var n of S)n.call(this,v)}var Fe=f("<p>Loading comments...</p>"),Le=f('<p class="error svelte-10mb2nl"> </p> <button class="retry-button svelte-10mb2nl">Retry</button>',1),Pe=f("<p>No comments yet. Be the first to comment!</p>"),Se=f('<div class="comment svelte-10mb2nl"><p class="svelte-10mb2nl"><strong class="username svelte-10mb2nl"> </strong> </p> <small class="svelte-10mb2nl"> </small></div>'),$e=f('<div class="comments-list svelte-10mb2nl"></div>'),qe=f('<div class="comment-form svelte-10mb2nl"><textarea placeholder="Add a comment..." rows="4" class="svelte-10mb2nl"></textarea> <button class="comment-button svelte-10mb2nl">Post Comment</button></div>'),Ne=f('<p>Please <button class="link-button svelte-10mb2nl">log in</button> to post a comment.</p>'),je=f('<div class="modal-overlay svelte-10mb2nl"><div class="modal-content svelte-10mb2nl"><button class="close-button svelte-10mb2nl">Ã—</button> <h2 class="svelte-10mb2nl"> </h2> <!> <!></div></div> <!>',1);function et(P,v){var T,V,W;ge(v,!1);const[g,S]=Ee(),n=()=>Me(De,"$user",g);let r=R(v,"id",8),E=R(v,"drawing_id",8),H=R(v,"onClose",8),b=U([]),h=U(""),_=U(!1),l=U(null),w=U(!1);!r()||!E()?(o(l,"Invalid drawing ID or UUID"),console.error("CommentsModal mounted with invalid props:",{id:r(),drawing_id:E()})):console.log("CommentsModal mounted with props:",{id:r(),drawing_id:E(),idLength:(T=r())==null?void 0:T.length,userId:(V=n())==null?void 0:V.id,userEmail:(W=n())==null?void 0:W.email});function te(e){return n()&&n().id===e&&n().email?n().email.split("@")[0]:e.slice(0,8)}async function D(){if(!r()){o(l,"Cannot load comments: Missing drawing UUID"),console.error("fetchComments called with invalid id:",r());return}o(_,!0),o(l,null),console.log("Fetching comments for UUID:",r());try{const{data:e,error:t}=await ee.from("comments").select("id, user_id, content, created_at, display_name").eq("drawing_id",r()).order("created_at",{ascending:!1});t?(o(l,`Failed to load comments: ${t.message}`),console.error("Error fetching comments:",t),o(b,[])):(o(b,e.map(a=>({...a,display_name:a.display_name||te(a.user_id)}))),console.log("Fetched comments:",s(b)))}catch(e){o(l,`Unexpected error loading comments: ${e.message}`),console.error("Unexpected error in fetchComments:",e),o(b,[])}o(_,!1)}async function oe(){var e;if(!(!n()||!s(h).trim())){if(!r()){o(l,"Cannot post comment: Missing drawing UUID"),console.error("postComment called with invalid id:",r());return}o(_,!0),o(l,null);try{const t={drawing_id:r(),user_id:n().id,content:s(h).trim(),display_name:((e=n().email)==null?void 0:e.split("@")[0])||n().id.slice(0,8)},{error:a}=await ee.from("comments").insert([t]);if(a)throw new Error(`Failed to post comment: ${a.message}`);console.log("Comment posted successfully"),o(h,""),await D()}catch(t){o(l,`Error: ${t.message}`),console.error("Error posting comment:",t)}o(_,!1)}}function ae(){localStorage.setItem("sb-redirect",window.location.pathname),o(w,!0)}be(()=>{var e,t;console.log("CommentsModal mounted. Authenticated user ID:",(e=n())==null?void 0:e.id,"Email:",(t=n())==null?void 0:t.email),r()?D().catch(a=>{console.error("Error in onMount fetchComments:",a),o(l,`Failed to initialize comments: ${a.message}`)}):console.error("onMount skipped due to invalid id:",r())}),ke();var J=je(),I=Y(J),$=c(I),K=c($),q=d(K,2),se=c(q);i(q);var Q=d(q,2);{var re=e=>{var t=Fe();p(e,t)},ne=(e,t)=>{{var a=m=>{var F=Le(),C=Y(F),N=c(C,!0);i(C);var u=d(C,2);L(()=>k(N,s(l))),y("click",u,D),p(m,F)},A=(m,F)=>{{var C=u=>{var x=Pe();p(u,x)},N=u=>{var x=$e();Ce(x,5,()=>s(b),j=>j.id,(j,z)=>{var B=Se(),G=c(B),O=c(G),ve=c(O,!0);i(O);var ue=d(O);i(G);var X=d(G,2),pe=c(X,!0);i(X),i(B),L(fe=>{k(ve,s(z).display_name||"User"),k(ue,`: ${s(z).content??""}`),k(pe,fe)},[()=>new Date(s(z).created_at).toLocaleString()],Z),p(j,B)}),i(x),p(u,x)};M(m,u=>{s(b).length===0?u(C):u(N,!1)},F)}};M(e,m=>{s(l)?m(a):m(A,!1)},t)}};M(Q,e=>{s(_)?e(re):e(ne,!1)})}var le=d(Q,2);{var ie=e=>{var t=qe(),a=c(t);ye(a);var A=d(a,2);i(t),L(m=>{a.disabled=s(_),A.disabled=m},[()=>s(_)||!s(h).trim()],Z),xe(a,()=>s(h),m=>o(h,m)),y("click",A,oe),p(e,t)},me=e=>{var t=Ne(),a=d(c(t));we(),i(t),y("click",a,ae),p(e,t)};M(le,e=>{n()?e(ie):e(me,!1)})}i($),i(I);var ce=d(I,2);{var de=e=>{Ie(e,{get show(){return s(w)},set show(t){o(w,t)},$$events:{authSuccess:()=>{o(w,!1),D()},authError:({detail:t})=>{o(l,t.message),o(w,!1)}},$$legacy:!0})};M(ce,e=>{s(w)&&e(de)})}L(()=>k(se,`Comments for Drawing #${E()||"Unknown"}`)),y("click",K,function(...e){var t;(t=H())==null||t.apply(this,e)}),y("click",$,Ue(function(e){Ae.call(this,v,e)})),y("click",I,function(...e){var t;(t=H())==null||t.apply(this,e)}),p(P,J),he(),S()}export{et as C};
