import{t as L,a as D,c as Ae}from"../chunks/DPmhzSt5.js";import{i as Q}from"../chunks/CHpTJ84V.js";import{h as de,p as $,o as me,a1 as j,t as e,A as B,$ as z,aC as Ie,av as fe,aD as Me,ay as X,v as ie,a as ee,Y as T,az as x,Z as C,ax as ne,aW as Pe,u as ge}from"../chunks/BDHGhfTE.js";import{s as K}from"../chunks/CTjs_13Y.js";import{i as Y}from"../chunks/1K336M6a.js";import{p as m,a as Oe,c as O,b as J,d as Re}from"../chunks/ChMpMzq7.js";import{w as H}from"../chunks/DH2AK175.js";import{s as V,a as je}from"../chunks/BqOODIDs.js";import{e as E}from"../chunks/CvTsB6m-.js";import{t as Be,s as le}from"../chunks/5ddwAlOI.js";import{b as Fe}from"../chunks/RZ2m-Vl7.js";import{e as Ne,i as We}from"../chunks/CgxHyAce.js";import{a as Ye,r as qe}from"../chunks/D02H29ki.js";import{b as Ue}from"../chunks/BvDJoXBx.js";import{C as He}from"../chunks/DR4qTk9g.js";import{t as Xe,f as Ze}from"../chunks/CNoJYvQC.js";function oe(p,r,u,d){var i=p.__style;if(de||i!==r){var c=Be(r);(!de||c!==p.getAttribute("style"))&&(c==null?p.removeAttribute("style"):p.style.cssText=c),p.__style=r}return d}var Ge=L("<canvas></canvas>");function he(p,r){$(r,!1);let u=m(r,"color",8),d=m(r,"size",8),i=m(r,"canvasStore",8),c=m(r,"disabled",8,!1),l=B(),t=B(),f=!1,o=null;me(()=>{if(j(t,e(l).getContext("2d")),!e(t)){console.error("Failed to get 2D context");return}return console.log("Canvas bound:",!!e(l)),i()?i().set({canvas:e(l)}):console.warn("canvasStore not provided; canvas not stored"),h(),c()||S(),()=>{window.removeEventListener("resize",h),e(l).removeEventListener("touchstart",w),e(l).removeEventListener("touchmove",w),i()&&i().set({canvas:null})}});function h(){e(l)&&(z(l,e(l).width=window.innerWidth),z(l,e(l).height=window.innerHeight),b())}function b(){e(t)&&(z(t,e(t).fillStyle="white"),e(t).fillRect(0,0,e(l).width,e(l).height))}function w(a){a.preventDefault()}function S(){e(l).addEventListener("touchstart",w,{passive:!1}),e(l).addEventListener("touchmove",w,{passive:!1}),window.addEventListener("resize",h)}function I(a){const g=e(l).getBoundingClientRect();return"touches"in a?{x:a.touches[0].clientX-g.left,y:a.touches[0].clientY-g.top}:{x:a.offsetX,y:a.offsetY}}function F(a){c()||(a.preventDefault(),f=!0,o=I(a),o&&R(o.x,o.y))}function N(a){if(!f||!o||c())return;a.preventDefault();const g=o;o=I(a),e(t)&&(z(t,e(t).lineWidth=d()),z(t,e(t).lineCap="round"),z(t,e(t).strokeStyle=u()),e(t).beginPath(),e(t).moveTo(g.x,g.y),e(t).lineTo(o.x,o.y),e(t).stroke())}function A(a){c()||(a.preventDefault(),f=!1,o=null)}function R(a,g){e(t)&&(z(t,e(t).fillStyle=u()),e(t).beginPath(),e(t).arc(a,g,d()/2,0,Math.PI*2),e(t).fill())}Ie(()=>(e(t),fe(u()),fe(d())),()=>{e(t)&&(u()||d())&&(z(t,e(t).strokeStyle=u()),z(t,e(t).lineWidth=d()),z(t,e(t).fillStyle=u()))}),Me(),Q();var _=Ge();let M;Fe(_,a=>j(l,a),()=>e(l)),X(a=>M=le(_,1,"svelte-nqephp",null,M,a),[()=>({disabled:c()})],ie),E("pointerdown",_,F),E("pointermove",_,N),E("pointerup",_,A),E("pointerleave",_,A),D(p,_),ee()}var Je=L('<div class="controls svelte-ci69nk"><button class="control-button svelte-ci69nk" aria-label="Toggle menu"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svelte-ci69nk"><circle cx="12" cy="12" r="1"></circle><circle cx="12" cy="5" r="1"></circle><circle cx="12" cy="19" r="1"></circle></svg></button> <button class="control-button svelte-ci69nk" aria-label="Save drawing"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svelte-ci69nk"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg></button> <button class="control-button svelte-ci69nk" aria-label="Go back"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svelte-ci69nk"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg></button></div>');function Ve(p,r){$(r,!1);let u=m(r,"onSave",8),d=m(r,"onMenuToggle",8),i=m(r,"canvasStore",8),c=null;i().subscribe(b=>{c=b.canvas,console.log("Canvas updated in DrawingControls:",!!c)});function l(){c?u()(c):console.error("Canvas not available")}Q();var t=Je(),f=T(t),o=x(f,2),h=x(o,2);C(t),E("click",f,function(...b){var w;(w=d())==null||w.apply(this,b)}),E("click",o,l),E("click",h,()=>window.history.back()),D(p,t),ee()}var Ke=L("<button></button>"),Qe=L('<div class="advanced-options svelte-lhy0b3"><label class="option svelte-lhy0b3"><input type="checkbox"> Pressure Sensitivity</label> <label class="option svelte-lhy0b3"><input type="checkbox" checked> Smooth Strokes</label></div>'),$e=L('<div class="menu svelte-lhy0b3"><div class="section svelte-lhy0b3"><h3 class="section-title svelte-lhy0b3">Colors</h3> <div class="color-grid svelte-lhy0b3"></div></div> <div class="section svelte-lhy0b3"><h3 class="section-title svelte-lhy0b3">Brush Size</h3> <div class="slider-container svelte-lhy0b3"><input type="range" min="1" max="50" class="size-slider svelte-lhy0b3"> <span class="size-value svelte-lhy0b3"> </span></div></div> <div class="section svelte-lhy0b3"><button class="advanced-toggle svelte-lhy0b3"> </button> <!></div></div>');function et(p,r){$(r,!1);let u=m(r,"colors",8),d=m(r,"selected",8),i=m(r,"size",12),c=m(r,"onColorChange",8),l=m(r,"onSizeChange",8),t=B(!1);Q();var f=$e(),o=T(f),h=x(T(o),2);Ne(h,5,u,We,(a,g)=>{var P=Ke();let Z;X(te=>{Z=le(P,1,"color-button svelte-lhy0b3",null,Z,te),oe(P,`background-color: ${e(g)??""}`),Ye(P,"aria-label",e(g))},[()=>({selected:d()===e(g)})],ie),E("click",P,()=>c()(e(g))),D(a,P)}),C(h),C(o);var b=x(o,2),w=x(T(b),2),S=T(w);qe(S);var I=x(S,2),F=T(I);C(I),C(w),C(b);var N=x(b,2),A=T(N),R=T(A,!0);C(A);var _=x(A,2);{var M=a=>{var g=Qe();D(a,g)};Y(_,a=>{e(t)&&a(M)})}C(N),C(f),X(()=>{oe(S,`--thumb-color: ${d()??""}`),oe(I,`color: ${d()??""}`),K(F,`${i()??""}px`),K(R,e(t)?"Hide Advanced":"Show Advanced")}),Ue(S,i),E("input",S,()=>l()(i())),E("click",A,()=>j(t,!e(t))),D(p,f),ee()}var tt=L("<div> </div>");function st(p,r){let u=m(r,"message",8),d=m(r,"show",8),i=m(r,"type",8,"success");var c=Ae(),l=ne(c);{var t=f=>{var o=tt();let h;var b=T(o,!0);C(o),X(w=>{h=le(o,1,"toast svelte-1q32h6p",null,h,w),K(b,u())},[()=>({success:i()==="success",error:i()==="error"})],ie),Xe(3,o,()=>Ze,()=>({duration:300})),D(f,o)};Y(l,f=>{d()&&f(t)})}D(p,c)}var at=L("<p>Loading...</p>"),rt=L("<p> </p>"),ot=L("<!> <!> <!>",1),nt=L("<!> <!>",1);function St(p,r){$(r,!1);const[u,d]=Oe(),i=()=>J(o,"$sessionStore",u),c=()=>J(b,"$error",u),l=()=>J(h,"$loading",u),t=()=>J(S,"$toastState",u);let f=m(r,"data",8);const o=H(f().session),h=H(!0),b=H(null),w=H({canvas:null}),S=H({message:"",visible:!1,type:"success"}),I=["red","green","blue","black","white"],F="black",N=10,A=3e3;let R=B(F),_=B(N),M=B(!1),a=B(F),g=null,P;me(async()=>{try{const{data:{session:s}}=await V.auth.getSession();O(o,s||f().session),g=await je(),console.log("Create page user:",g),console.log("Create page session:",i()),console.log("Client cookies:",document.cookie);const{data:n}=V.auth.onAuthStateChange((v,y)=>{var k;console.log("Auth state changed:",v,(k=y==null?void 0:y.user)==null?void 0:k.email),O(o,y)});return()=>{n.subscription.unsubscribe()}}catch(s){O(b,s instanceof Error?s.message:"Failed to load session"),console.error("Session sync error:",s)}finally{O(h,!1)}}),Pe(()=>{});const Z=s=>s.split("@")[0]||"user";async function te(s){try{const{count:n,error:v}=await V.from("drawings").select("*",{count:"exact",head:!0}).eq("user_id",s);if(v)throw v;return n||0}catch(n){return console.error("Error fetching drawing count:",n),O(b,"Failed to fetch drawing count"),0}}async function pe(s,n){const v=Z(s),y=await te(n)+1;return`${v}-${y}`}async function be(s){var n;if(!s){q("No canvas element found","error");return}if(!((n=i())!=null&&n.user)){q("Please login to save drawings","error");return}O(h,!0);try{await we(),await ye(s),q("Drawing saved successfully!","success")}catch(v){_e(v)}finally{O(h,!1)}}async function we(){var s,n;try{console.log("Fetching rate limit check for user:",(s=i())==null?void 0:s.user.id);const v=await fetch("/api/check-rate-limit",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:(n=i())==null?void 0:n.user.id})});if(!v.ok)throw new Error("Rate limit service unavailable");const y=await v.json();if(y.blocked)throw new Error(y.message||"You are temporarily banned due to excessive submissions");y.limited&&q(y.message||"Warning: approaching submission limit","warning")}catch(v){throw console.error("[Rate Limit]",v),v}}async function ye(s){try{const n=s.toDataURL("image/png"),v=new Date().toISOString(),y=await pe(i().user.email,i().user.id),{error:k}=await V.from("drawings").insert({drawing_id:y,image_data:n,user_id:i().user.id,user_email:i().user.email,created_at:v,blocked:!1,likes:0,comments:{}});if(k)throw k}catch(n){throw console.error("[Supabase] Persist error:",n),n}}function _e(s){const n=s instanceof Error?s.message:"Failed to save drawing";console.error("[DrawingApp] Save error:",s),q(n,"error")}function q(s,n){clearTimeout(P),O(S,{message:s,visible:!0,type:n}),P=setTimeout(()=>{Re(S,ge(t).visible=!1,ge(t))},A)}function ke(s){j(a,j(R,s))}function Se(s){j(_,Math.max(1,Math.min(50,s)))}function Ce(){j(M,!e(M))}Q();var ce=nt(),ue=ne(ce);{var xe=s=>{var n=at();D(s,n)},De=(s,n)=>{{var v=k=>{var U=rt(),se=T(U);C(U),X(()=>K(se,`Error: ${c()??""}`)),D(k,U)},y=(k,U)=>{{var se=W=>{var G=ot(),ae=ne(G);he(ae,{get color(){return e(R)},get size(){return e(_)},canvasStore:w});var ve=x(ae,2);Ve(ve,{canvasStore:w,onSave:be,onMenuToggle:Ce});var Ee=x(ve,2);{var Le=re=>{et(re,{colors:I,get selected(){return e(a)},get size(){return e(_)},onColorChange:ke,onSizeChange:Se})};Y(Ee,re=>{e(M)&&re(Le)})}D(W,G)},Te=W=>{He(W,{message:"You need to log in to start creating",children:(G,ae)=>{he(G,{get color(){return e(R)},get size(){return e(_)},disabled:!0})},$$slots:{default:!0}})};Y(k,W=>{i()?W(se):W(Te,!1)},U)}};Y(s,k=>{c()?k(v):k(y,!1)},n)}};Y(ue,s=>{l()?s(xe):s(De,!1)})}var ze=x(ue,2);st(ze,{get message(){return t().message},get show(){return t().visible},get type(){return t().type}}),D(p,ce),ee(),d()}export{St as component};
