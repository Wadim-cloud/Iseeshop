import"../chunks/CWj6FrbW.js";import"../chunks/69_IOA4Y.js";import{p as Ae,o as Ve,x as e,G as p,az as Me,ay as Je,A as t,a as Ee,al as Ke,ak as Qe,am as Xe,an as le,ap as l,ar as m,as as v,ao as H,w as be,ax as Fe,aB as Ye,aq as Ze}from"../chunks/9BOlcS-b.js";import{e as X,r as et,s as j,h as tt}from"../chunks/BsZz1DC-.js";import{i as b}from"../chunks/WEOj8Vpi.js";import{t as d,a as r,b as De,n as Te}from"../chunks/Bnw62dMu.js";import{s as Ne}from"../chunks/CTf98LKf.js";import{s as ce}from"../chunks/Cb2afnRg.js";import{t as se,a as me,f as Ue}from"../chunks/BxKlmk9s.js";import{i as Pe}from"../chunks/xvq0-Hdq.js";import{s as qe,a as Be}from"../chunks/BR43cs2B.js";import{p as at}from"../chunks/DONeNFOh.js";import{b as st}from"../chunks/trMeve9e.js";import{A as He}from"../chunks/CM5gJEXl.js";import{e as Le,i as ot}from"../chunks/DhNq3B23.js";import{b as rt}from"../chunks/9x1-h8O0.js";import{b as it}from"../chunks/BaLMMi1F.js";import{p as lt}from"../chunks/Cmn9WjR9.js";import{s as ie}from"../chunks/BeMxMaC5.js";import{u as nt}from"../chunks/yrXH0Tcs.js";import{g as ye,i as Ie}from"../chunks/zThV1SCZ.js";var dt=d('<canvas class="shader svelte-kwfl0c"></canvas>');function vt(ne,oe){Ae(oe,!1);let C=p(),Y;Ve(()=>{if(!e(C))return;const f=e(C).getContext("2d");if(!f)return;const y=()=>{Me(C,e(C).width=window.innerWidth),Me(C,e(C).height=window.innerHeight);const k=f.createLinearGradient(0,0,e(C).width,e(C).height);k.addColorStop(0,"#f0f0f0"),k.addColorStop(1,"#d0e0ff"),f.fillStyle=k,f.fillRect(0,0,e(C).width,e(C).height),Y=requestAnimationFrame(y)};return y(),()=>{cancelAnimationFrame(Y)}}),Je(()=>{cancelAnimationFrame(Y)}),Pe();var g=dt();st(g,f=>t(C,f),()=>e(C)),r(ne,g),Ee()}var ct=d('<div class="loading svelte-99wzd5"><div class="spinner svelte-99wzd5"></div></div>'),mt=d('<div class="error-message svelte-99wzd5" role="alert"> </div> <button class="retry-button svelte-99wzd5">Retry</button>',1),ut=d('<p class="no-comments svelte-99wzd5">No comments yet.</p>'),gt=d('<div class="spinner small svelte-99wzd5"></div>'),ft=d('<span class="heart svelte-99wzd5"> </span> ',1),_t=d('<div class="comment-item svelte-99wzd5"><div class="comment-header svelte-99wzd5"><span class="username svelte-99wzd5"> </span> <span class="timestamp svelte-99wzd5"> </span></div> <p class="comment-content svelte-99wzd5"> </p> <div class="comment-actions svelte-99wzd5"><button class="react-button svelte-99wzd5"><!></button> <button class="view-drawing svelte-99wzd5" aria-label="View drawing">View Drawing</button></div></div>'),pt=d('<div class="comment-list svelte-99wzd5"></div>'),ht=d('<option class="svelte-99wzd5"> </option>'),wt=d('<select class="svelte-99wzd5"><option disabled class="svelte-99wzd5">Select a drawing</option><!></select>'),bt=d('<p class="svelte-99wzd5">No drawings available to comment on.</p>'),yt=d('<div class="comment-form svelte-99wzd5"><!> <textarea placeholder="Add a comment..." rows="4" class="svelte-99wzd5"></textarea> <button class="comment-button svelte-99wzd5">Post Comment</button></div>'),kt=d('<p class="svelte-99wzd5">Please <button class="link-button svelte-99wzd5">log in</button> to post a comment or react.</p>'),zt=d('<div class="comment-modal-container svelte-99wzd5"><div class="modal svelte-99wzd5"><button class="close-button svelte-99wzd5" aria-label="Close comment modal"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" class="svelte-99wzd5"><path d="M18 6L6 18M6 6l12 12" stroke="white" stroke-width="2" stroke-linecap="round" class="svelte-99wzd5"></path></svg></button> <h2 class="svelte-99wzd5">Recent Comments</h2> <!> <!></div></div>'),xt=d("<!> <!>",1);function Ct(ne,oe){Ae(oe,!1);const[C,Y]=qe(),g=()=>Be(nt,"$user",C);let f=lt(oe,"show",12),y=p([]),k=p([]),h=p(""),F=p(""),E=p(!1),J=p(null),A=p(null),T=p(!1);function ue(a){return g()&&g().id===a&&g().email?g().email.split("@")[0]:a.slice(0,8)}async function Z(){var a;t(E,!0),t(A,null);try{const{data:s,error:c}=await ie.from("drawings").select("id, drawing_id").eq("blocked",!1).order("created_at",{ascending:!1});if(c)throw new Error(`Failed to load drawings: ${c.message}`);t(k,s.map(n=>({id:n.id,drawing_id:n.drawing_id}))),t(h,((a=e(k)[0])==null?void 0:a.drawing_id)||"");const{data:z,error:_}=await ie.from("comments").select("id, drawing_id, user_id, content, created_at, display_name, reactions").order("created_at",{ascending:!1});if(_)throw new Error(`Failed to load comments: ${_.message}`);t(y,z.map(n=>({...n,display_name:n.display_name||ue(n.user_id),reactions:Array.isArray(n.reactions)?n.reactions:[]}))),console.log("Fetched comments:",e(y))}catch(s){t(A,`Unexpected error loading comments: ${s.message}`),console.error("Unexpected error in fetchComments:",s),t(y,[]),t(k,[])}t(E,!1)}async function ge(){var a;if(!g()||!e(F).trim()||!e(h)){t(A,"Please select a drawing and enter a comment");return}t(E,!0),t(A,null);try{const s=e(k).find(_=>_.drawing_id===e(h));if(!s)throw new Error("Selected drawing not found");const c={drawing_id:s.id,user_id:g().id,content:e(F).trim(),display_name:((a=g().email)==null?void 0:a.split("@")[0])||g().id.slice(0,8)},{error:z}=await ie.from("comments").insert([c]);if(z)throw new Error(`Failed to post comment: ${z.message}`);console.log("Comment posted successfully"),t(F,""),await Z()}catch(s){t(A,`Error posting comment: ${s.message}`),console.error("Error posting comment:",s)}t(E,!1)}async function fe(a){if(!g()){localStorage.setItem("sb-redirect",window.location.pathname),t(T,!0);return}t(J,a),t(A,null);try{const s=e(y).find(n=>n.id===a);if(!s)throw new Error("Comment not found");const c=s.reactions.some(n=>n.user_id===g().id);let z;c?z=s.reactions.filter(n=>n.user_id!==g().id):z=[...s.reactions,{user_id:g().id,created_at:new Date().toISOString()}];const{error:_}=await ie.from("comments").update({reactions:z}).eq("id",a);if(_)throw new Error(`Failed to update reactions: ${_.message}`);t(y,e(y).map(n=>n.id===a?{...n,reactions:z}:n)),console.log("Reaction updated successfully")}catch(s){t(A,`Failed to react to comment: ${s.message}`),console.error("Reaction error:",s)}finally{t(J,null)}}function ke(a){if(!a||typeof a!="string"||a.trim()===""){console.error("Invalid drawingId:",a),t(A,"Cannot navigate: Invalid drawing ID");return}console.log("Navigating to drawing:",a),ye(`/gallery/${a}`),f(!1)}function ze(){console.log("Login prompt triggered"),localStorage.setItem("sb-redirect",window.location.pathname),t(T,!0)}Ke(()=>Qe(f()),()=>{f()&&(console.log("Comments modal opened, fetching comments"),Z())}),Xe(),Pe();var de=xt(),_e=le(de);{var xe=a=>{var s=zt(),c=m(s),z=m(c),_=l(z,4);{var n=$=>{var P=ct();r($,P)},ee=($,P)=>{{var G=N=>{var D=mt(),U=le(D),x=m(U,!0);v(U);var w=l(U,2);H(()=>j(x,e(A))),X("click",w,Z),r(N,D)},re=(N,D)=>{{var U=w=>{var L=ut();r(w,L)},x=w=>{var L=pt();Le(L,5,()=>e(y),te=>te.id,(te,S)=>{var O=_t(),o=m(O),i=m(o),R=m(i,!0);v(i);var q=l(i,2),K=m(q,!0);v(q),v(o);var ae=l(o,2),B=m(ae,!0);v(ae);var W=l(ae,2),Q=m(W),I=m(Q);{var ve=M=>{var V=gt();r(M,V)},Ge=M=>{var V=ft(),$e=le(V),We=m($e,!0);v($e);var je=l($e);H(Se=>{j(We,Se),j(je,` ${e(S).reactions.length??""}`)},[()=>e(S).reactions.some(Se=>{var Re;return Se.user_id===((Re=g())==null?void 0:Re.id)})?"❤️":"🤍"],be),r(M,V)};b(I,M=>{e(J)===e(S).id?M(ve):M(Ge,!1)})}v(Q);var Oe=l(Q,2);v(W),v(O),H((M,V)=>{j(R,e(S).display_name||"Anonymous"),j(K,M),j(B,e(S).content),Q.disabled=e(J)===e(S).id,Ne(Q,"aria-label",V)},[()=>new Date(e(S).created_at).toLocaleString(),()=>e(S).reactions.some(M=>{var V;return M.user_id===((V=g())==null?void 0:V.id)})?"Unlike comment":"Like comment"],be),X("click",Q,()=>fe(e(S).id)),X("click",Oe,()=>{var M;return ke(((M=e(k).find(V=>V.id===e(S).drawing_id))==null?void 0:M.drawing_id)||"")}),r(te,O)}),v(L),r(w,L)};b(N,w=>{e(y).length===0?w(U):w(x,!1)},D)}};b($,N=>{e(A)?N(G):N(re,!1)},P)}};b(_,$=>{e(E)?$(n):$(ee,!1)})}var pe=l(_,2);{var he=$=>{var P=yt(),G=m(P);{var re=x=>{var w=wt();H(()=>{e(h),Ye(()=>{e(E),e(k)})});var L=m(w);L.value=L.__value="";var te=l(L);Le(te,1,()=>e(k),ot,(S,O)=>{var o=ht(),i={},R=m(o);v(o),H(()=>{i!==(i=e(O).drawing_id)&&(o.value=(o.__value=e(O).drawing_id)??""),j(R,`Drawing #${e(O).drawing_id??""}`)}),r(S,o)}),v(w),H(()=>w.disabled=e(E)),it(w,()=>e(h),S=>t(h,S)),r(x,w)},N=x=>{var w=bt();r(x,w)};b(G,x=>{e(k).length>0?x(re):x(N,!1)})}var D=l(G,2);et(D);var U=l(D,2);v(P),H(x=>{D.disabled=e(E)||e(k).length===0,U.disabled=x},[()=>e(E)||!e(F).trim()||!e(h)],be),rt(D,()=>e(F),x=>t(F,x)),X("click",U,ge),r($,P)},we=$=>{var P=kt(),G=l(m(P));Fe(),v(P),X("click",G,ze),r($,P)};b(pe,$=>{g()?$(he):$(we,!1)})}v(c),v(s),X("click",z,()=>{console.log("Close comment modal clicked"),f(!1),t(A,null)}),se(3,c,()=>me,()=>({y:100,duration:400})),se(3,s,()=>Ue,()=>({duration:300})),r(a,s)};b(_e,a=>{f()&&a(xe)})}var Ce=l(_e,2);{var u=a=>{He(a,{get show(){return e(T)},set show(s){t(T,s)},$$events:{authSuccess:()=>{console.log("Auth success, refreshing comments"),t(T,!1),Z()},authError:({detail:s})=>{console.log("Auth error:",s.message),t(A,s.message),t(T,!1)}},$$legacy:!0})};b(Ce,a=>{e(T)&&a(u)})}r(ne,de),Ee(),Y()}var $t=d('<meta name="description" content="A collaborative creative platform for drawing, plotting, selling, and solving challenges." class="svelte-i1vkni">'),St=d('<div class="loader-container svelte-i1vkni" role="status" aria-live="polite"><div class="loader-overlay svelte-i1vkni"></div> <div class="loader-content svelte-i1vkni"><img src="/logo192.png" alt="Pexos Logo" class="loader-logo floating svelte-i1vkni"> <p class="loader-text svelte-i1vkni">Initializing Pexos...</p></div></div>'),At=d('<div class="svelte-i1vkni"><img src="/logo192.png" alt="Pexos Logo" class="hero-logo svelte-i1vkni"></div>'),Et=d('<div class="svelte-i1vkni"><h1 class="hero-title svelte-i1vkni">Pexos</h1></div>'),Pt=d('<div class="svelte-i1vkni"><p class="hero-subtitle svelte-i1vkni">A Collaborative Creative Platform</p></div>'),Rt=d('<div class="headline-section svelte-i1vkni"><h2 class="hero-headline svelte-i1vkni"><!> Create, Plot, Sell, and Solve Community Challenges</h2></div>'),Mt=Te('<path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z" fill="white" class="svelte-i1vkni"></path>'),Dt=Te('<path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm4.59-12.42L10 14.17l-2.59-2.58L6 13l4 4 8-8z" fill="white" class="svelte-i1vkni"></path>'),Lt=d('<div class="svelte-i1vkni"><button class="action-button svelte-i1vkni"><span class="button-icon svelte-i1vkni"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" class="svelte-i1vkni"><!></svg></span> </button></div>'),It=d('<div class="hero-container svelte-i1vkni"><div><!></div> <div></div> <div></div> <div></div> <div></div> <div class="hero-content svelte-i1vkni"><!> <!> <!> <!> <!></div></div>'),Vt=d('<div class="modal-debug svelte-i1vkni">Auth Modal should be visible</div> <!>',1),Ft=d('<div class="modal-debug svelte-i1vkni">Comment Modal should be visible</div> <!>',1),Tt=d("<!> <!> <!>",1);function ia(ne,oe){Ae(oe,!1);const[C,Y]=qe(),g=()=>Be(at,"$page",C);let f=p(!1),y=p(!1),k=p(!0),h=p(null),F=p(!1),E=p(!1),J=p(!1),A=p(!1),T=p(!1),ue=p(!1);Ve(async()=>{console.log("Root page mounted");try{const{data:{session:u},error:a}=await ie.auth.getSession();a&&console.error("Session check error:",a.message),t(h,u),console.log("Initial session:",e(h)?"User logged in":"No user"),setTimeout(()=>{t(k,!1),setTimeout(()=>t(F,!0),300),setTimeout(()=>t(E,!0),800),setTimeout(()=>t(J,!0),1300),setTimeout(()=>t(A,!0),1800),setTimeout(()=>t(T,!0),2200),setTimeout(()=>t(ue,!0),2800)},1e3);const s=g().url.searchParams.get("redirect");s&&(console.log("Redirect param:",s),localStorage.setItem("sb-redirect",decodeURIComponent(s)),e(h)?(console.log("User already signed in, redirecting to:",s),ye(decodeURIComponent(s),{replaceState:!0})):(console.log("No session, showing auth modal"),t(f,!0)));const{data:c}=ie.auth.onAuthStateChange(async(z,_)=>{var n;if(console.log("Auth state changed:",z,(n=_==null?void 0:_.user)==null?void 0:n.email),t(h,_),z==="SIGNED_IN"&&_){await Ie();const ee=localStorage.getItem("sb-redirect")||"/";localStorage.removeItem("sb-redirect"),console.log("Redirecting after sign-in:",ee),ye(ee,{replaceState:!0})}});return()=>c.subscription.unsubscribe()}catch(u){console.error("Session check failed:",u),t(k,!1)}});function Z(){e(h)?(console.log("User logged in, toggling comment modal"),t(y,!0)):(console.log("No user, showing auth modal"),t(f,!0)),console.log("Modal states:",{showAuthModal:e(f),showCommentModal:e(y)})}Pe();var ge=Tt();tt(u=>{var a=$t();Ze.title="Pexos - Creative Platform",r(u,a)});var fe=le(ge);{var ke=u=>{var a=St();r(u,a)},ze=u=>{var a=It(),s=m(a);let c;var z=m(s);vt(z,{}),v(s);var _=l(s,2);let n;var ee=l(_,2);let pe;var he=l(ee,2);let we;var $=l(he,2);let P;var G=l($,2),re=m(G);{var N=o=>{var i=At();se(1,i,()=>me,()=>({y:50,duration:1e3})),r(o,i)};b(re,o=>{e(J)&&o(N)})}var D=l(re,2);{var U=o=>{var i=Et();se(1,i,()=>me,()=>({y:50,duration:1e3,delay:200})),r(o,i)};b(D,o=>{e(J)&&o(U)})}var x=l(D,2);{var w=o=>{var i=Pt();se(1,i,()=>me,()=>({y:30,duration:800,delay:300})),r(o,i)};b(x,o=>{e(A)&&o(w)})}var L=l(x,2);{var te=o=>{var i=Rt(),R=m(i),q=m(R);{var K=B=>{var W=De();H(()=>j(W,`Welcome back, ${e(h).user.email??""}!`)),r(B,W)},ae=B=>{var W=De("Join the Pexos community and unleash your creativity!");r(B,W)};b(q,B=>{e(h)?B(K):B(ae,!1)})}Fe(),v(R),v(i),se(1,i,()=>me,()=>({x:-100,duration:1e3,delay:400})),r(o,i)};b(L,o=>{e(T)&&o(te)})}var S=l(L,2);{var O=o=>{var i=Lt(),R=m(i),q=m(R),K=m(q),ae=m(K);{var B=I=>{var ve=Mt();r(I,ve)},W=I=>{var ve=Dt();r(I,ve)};b(ae,I=>{e(h)?I(B):I(W,!1)})}v(K),v(q);var Q=l(q);v(R),v(i),H(()=>{Ne(R,"aria-label",e(h)?"View comments":"Sign in to Pexos"),j(Q,` ${e(h)?"View Comments":"Sign In"}`)}),X("click",R,Z),X("keydown",R,I=>(I.key==="Enter"||I.key==="Space")&&Z()),se(1,i,()=>Ue,()=>({duration:800,delay:500})),r(o,i)};b(S,o=>{e(ue)&&o(O)})}v(G),v(a),H((o,i,R,q,K)=>{c=ce(s,1,"shader-layer svelte-i1vkni",null,c,o),n=ce(_,1,"overlay-layer svelte-i1vkni",null,n,i),pe=ce(ee,1,"deco-element top-right svelte-i1vkni",null,pe,R),we=ce(he,1,"deco-element bottom-left svelte-i1vkni",null,we,q),P=ce($,1,"deco-element center-glow svelte-i1vkni",null,P,K)},[()=>({active:e(F)}),()=>({"fade-out":e(F)}),()=>({visible:e(E)}),()=>({visible:e(E)}),()=>({visible:e(E)})],be),r(u,a)};b(fe,u=>{e(k)?u(ke):u(ze,!1)})}var de=l(fe,2);{var _e=u=>{var a=Vt(),s=l(le(a),2);He(s,{get show(){return e(f)},set show(c){t(f,c)},$$events:{authSuccess:async()=>{console.log("Auth success event"),await Ie();const c=localStorage.getItem("sb-redirect")||"/";localStorage.removeItem("sb-redirect"),console.log("Redirecting after auth success:",c),ye(c,{replaceState:!0})},authError:({detail:c})=>{console.log("Auth error:",c.message),t(f,!1)}},$$legacy:!0}),r(u,a)};b(de,u=>{e(f)&&u(_e)})}var xe=l(de,2);{var Ce=u=>{var a=Ft(),s=l(le(a),2);Ct(s,{get show(){return e(y)},set show(c){t(y,c)},$$legacy:!0}),r(u,a)};b(xe,u=>{e(y)&&u(Ce)})}r(ne,ge),Ee(),Y()}export{ia as component};
