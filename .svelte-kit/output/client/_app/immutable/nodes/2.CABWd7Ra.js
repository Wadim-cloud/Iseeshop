import{t as v,a as l,b as Ee,n as Ie}from"../chunks/B2hSDNwb.js";import{i as Re}from"../chunks/BkJq1j4_.js";import{p as Le,ai as Ge,au as Je,aj as We,aw as ie,al as n,x as e,I as w,a as Ve,A as s,am as m,an as d,ak as B,w as be,ax as De,az as Ke,o as Qe,aA as Xe}from"../chunks/Bxdg7ccW.js";import{e as Z,r as Ye,s as Q,h as Ze}from"../chunks/6og0jn-Y.js";import{i as y}from"../chunks/Bqnn9XxY.js";import{a as Te}from"../chunks/CcUbZ0dA.js";import{s as ve}from"../chunks/UMIFvBL3.js";import{t as se,f as me,a as ze}from"../chunks/CVktCSDB.js";import{s as Ne,a as Ue}from"../chunks/CP6E_JcI.js";import{s as et,g as we,i as Pe}from"../chunks/IbqXbPHK.js";import{C as tt}from"../chunks/dNzaCE8p.js";import{A as at}from"../chunks/3YYhwEwk.js";import{e as Me,i as st}from"../chunks/ucczKhfM.js";import{b as ot}from"../chunks/cLJjU_P4.js";import{b as rt}from"../chunks/DQEqFSD1.js";import{p as it}from"../chunks/Czyh_-as.js";import{s as oe}from"../chunks/wkM8Wptt.js";import{u as lt}from"../chunks/Q9OjFAKz.js";const nt=()=>{const H=et;return{page:{subscribe:H.page.subscribe},navigating:{subscribe:H.navigating.subscribe},updated:H.updated}},ct={subscribe(H){return nt().page.subscribe(H)}};var dt=v('<div class="loading svelte-jppu89"><div class="spinner svelte-jppu89"></div></div>'),vt=v('<div class="error-message svelte-jppu89" role="alert"> </div> <button class="retry-button svelte-jppu89">Retry</button>',1),mt=v('<p class="no-comments svelte-jppu89">No comments yet.</p>'),ut=v('<div class="spinner small svelte-jppu89"></div>'),pt=v('<span class="heart svelte-jppu89"> </span> ',1),gt=v('<div class="comment-item svelte-jppu89"><div class="comment-header svelte-jppu89"><span class="username svelte-jppu89"> </span> <span class="timestamp svelte-jppu89"> </span></div> <p class="comment-content svelte-jppu89"> </p> <div class="comment-actions svelte-jppu89"><button class="react-button svelte-jppu89"><!></button> <button class="view-drawing svelte-jppu89" aria-label="View drawing">View Drawing</button></div></div>'),_t=v('<div class="comment-list svelte-jppu89"></div>'),ft=v('<option class="svelte-jppu89"> </option>'),ht=v('<select class="svelte-jppu89"><option disabled class="svelte-jppu89">Select a drawing</option><!></select>'),bt=v('<p class="svelte-jppu89">No drawings available to comment on.</p>'),wt=v('<div class="comment-form svelte-jppu89"><!> <textarea placeholder="Add a comment..." rows="4" class="svelte-jppu89"></textarea> <button class="comment-button svelte-jppu89">Post Comment</button></div>'),yt=v('<p class="svelte-jppu89">Please <button class="link-button svelte-jppu89">log in</button> to post a comment or react.</p>'),kt=v('<div class="comment-modal-container svelte-jppu89"><div class="modal svelte-jppu89"><button class="close-button svelte-jppu89" aria-label="Close comment modal"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" class="svelte-jppu89"><path d="M18 6L6 18M6 6l12 12" stroke="white" stroke-width="2" stroke-linecap="round" class="svelte-jppu89"></path></svg></button> <h2 class="svelte-jppu89">Recent Comments</h2> <!> <!></div></div>'),Ct=v("<!> <!>",1);function xt(H,le){Le(le,!1);const[ye,ke]=Ne(),A=()=>Ue(lt,"$user",ye);let I=it(le,"show",12),h=w([]),R=w([]),g=w(""),V=w(""),E=w(!1),X=w(null),S=w(null),q=w(!1);function re(a){let t=0;const c=`${a.user_id}${a.created_at}`;for(let o=0;o<c.length;o++)t=(t<<5)-t+c.charCodeAt(o),t|=0;return Math.abs(t)}function ue(a,t,c){if("user"in a)return{id:re({user_id:a.user,content:a.text,created_at:t}),user_id:a.user,content:a.text,created_at:t,display_name:a.user.slice(0,8),reactions:[],drawing_id:c};const o=a;return{...o,id:o.id||re({...o}),reactions:o.reactions||[],drawing_id:c}}async function ee(){var a;s(E,!0),s(S,null);try{const{data:t,error:c}=await oe.from("drawings").select("id, drawing_id, comments, user_email, created_at").eq("blocked",!1).order("created_at",{ascending:!1});c?(s(S,`Failed to load comments: ${c.message}`),console.error("Error fetching drawings:",c),s(h,[]),s(R,[])):(console.log("Fetched drawings:",t),s(R,t.map(o=>({id:o.id,drawing_id:o.drawing_id}))),s(g,((a=e(R)[0])==null?void 0:a.drawing_id)||""),s(h,[]),t.forEach(o=>{const k=Array.isArray(o.comments)?o.comments:[],P=o.created_at||new Date().toISOString(),G=k.map(D=>ue(D,P,o.drawing_id));s(h,[...e(h),...G])}),console.log("Processed comments:",e(h)))}catch(t){s(S,`Unexpected error loading comments: ${t.message}`),console.error("Unexpected error in fetchComments:",t),s(h,[]),s(R,[])}s(E,!1)}async function pe(){var a;if(!A()||!e(V).trim()||!e(g)){s(S,"Please select a drawing and enter a comment");return}s(E,!0),s(S,null);try{const t={id:re({user_id:A().id,content:e(V).trim(),created_at:new Date().toISOString(),drawing_id:e(g)}),user_id:A().id,content:e(V).trim(),created_at:new Date().toISOString(),display_name:((a=A().email)==null?void 0:a.split("@")[0])||A().id.slice(0,8),reactions:[],drawing_id:e(g)},{data:c,error:o}=await oe.from("drawings").select("comments").eq("drawing_id",e(g)).single();if(o)throw new Error(`Failed to fetch current comments: ${o.message}`);const P=[...Array.isArray(c==null?void 0:c.comments)?c.comments:[],t],{data:G,error:D}=await oe.from("drawings").update({comments:P}).eq("drawing_id",e(g)).select();if(D)throw new Error(`Failed to update comments: ${D.message}`);console.log("Comment posted successfully:",G),s(V,""),await ee()}catch(t){s(S,`Error posting comment: ${t.message}`),console.error("Error posting comment:",t)}s(E,!1)}async function Ce(a){if(!A()){localStorage.setItem("sb-redirect",window.location.pathname),s(q,!0);return}s(X,a),s(S,null);try{const t=e(h).find(p=>p.id===a);if(!t)throw new Error("Comment not found");const c=t.reactions.some(p=>p.user_id===A().id);let o;c?o=e(h).map(p=>p.id===a?{...p,reactions:p.reactions.filter(_=>_.user_id!==A().id)}:p):o=e(h).map(p=>p.id===a?{...p,reactions:[...p.reactions,{user_id:A().id,created_at:new Date().toISOString()}]}:p);const{data:k,error:P}=await oe.from("drawings").select("comments").eq("drawing_id",t.drawing_id).single();if(P)throw new Error(`Failed to fetch current comments: ${P.message}`);const D=(Array.isArray(k==null?void 0:k.comments)?k.comments:[]).map(p=>p.id===a&&o.find(_=>_.id===a)||p),{error:te}=await oe.from("drawings").update({comments:D}).eq("drawing_id",t.drawing_id);if(te)throw new Error(`Failed to update reactions: ${te.message}`);console.log("Reaction updated successfully"),s(h,o)}catch(t){s(S,`Failed to react to comment: ${t.message}`),console.error("Reaction error:",t)}finally{s(X,null)}}function xe(a){console.log("Navigating to drawing:",a),we(`/gallery/${a}`),I(!1)}function ge(){console.log("Login prompt triggered"),localStorage.setItem("sb-redirect",window.location.pathname),s(q,!0)}Ge(()=>Je(I()),()=>{I()&&(console.log("Comments modal opened, fetching comments"),ee())}),We(),Re();var _e=Ct(),fe=ie(_e);{var je=a=>{var t=kt(),c=m(t),o=m(c),k=n(o,4);{var P=_=>{var M=dt();l(_,M)},G=(_,M)=>{{var J=T=>{var z=vt(),N=ie(z),x=m(N,!0);d(N);var f=n(N,2);B(()=>Q(x,e(S))),Z("click",f,ee),l(T,z)},ne=(T,z)=>{{var N=f=>{var U=mt();l(f,U)},x=f=>{var U=_t();Me(U,5,()=>e(h),ae=>ae.id,(ae,j)=>{var i=gt(),r=m(i),C=m(r),F=m(C,!0);d(C);var W=n(C,2),ce=m(W,!0);d(W),d(r);var L=n(r,2),Y=m(L,!0);d(L);var he=n(L,2),$=m(he),de=m($);{var Fe=O=>{var K=ut();l(O,K)},qe=O=>{var K=pt(),$e=ie(K),Be=m($e,!0);d($e);var He=n($e);B(Se=>{Q(Be,Se),Q(He,` ${e(j).reactions.length??""}`)},[()=>e(j).reactions.some(Se=>{var Ae;return Se.user_id===((Ae=A())==null?void 0:Ae.id)})?"❤️":"🤍"],be),l(O,K)};y(de,O=>{e(X)===e(j).id?O(Fe):O(qe,!1)})}d($);var Oe=n($,2);d(he),d(i),B((O,K)=>{Q(F,e(j).display_name||"Anonymous"),Q(ce,O),Q(Y,e(j).content),$.disabled=e(X)===e(j).id,Te($,"aria-label",K)},[()=>new Date(e(j).created_at).toLocaleString(),()=>e(j).reactions.some(O=>{var K;return O.user_id===((K=A())==null?void 0:K.id)})?"Unlike comment":"Like comment"],be),Z("click",$,()=>Ce(e(j).id)),Z("click",Oe,()=>xe(e(j).drawing_id)),l(ae,i)}),d(U),l(f,U)};y(T,f=>{e(h).length===0?f(N):f(x,!1)},z)}};y(_,T=>{e(S)?T(J):T(ne,!1)},M)}};y(k,_=>{e(E)?_(P):_(G,!1)})}var D=n(k,2);{var te=_=>{var M=wt(),J=m(M);{var ne=x=>{var f=ht();B(()=>{e(g),Ke(()=>{e(E),e(R)})});var U=m(f);U.value=U.__value="";var ae=n(U);Me(ae,1,()=>e(R),st,(j,i)=>{var r=ft(),C={},F=m(r);d(r),B(()=>{C!==(C=e(i).drawing_id)&&(r.value=(r.__value=e(i).drawing_id)??""),Q(F,`Drawing #${e(i).drawing_id??""}`)}),l(j,r)}),d(f),B(()=>f.disabled=e(E)),rt(f,()=>e(g),j=>s(g,j)),l(x,f)},T=x=>{var f=bt();l(x,f)};y(J,x=>{e(R).length>0?x(ne):x(T,!1)})}var z=n(J,2);Ye(z);var N=n(z,2);d(M),B(x=>{z.disabled=e(E)||e(R).length===0,N.disabled=x},[()=>e(E)||!e(V).trim()||!e(g)],be),ot(z,()=>e(V),x=>s(V,x)),Z("click",N,pe),l(_,M)},p=_=>{var M=yt(),J=n(m(M));De(),d(M),Z("click",J,ge),l(_,M)};y(D,_=>{A()?_(te):_(p,!1)})}d(c),d(t),Z("click",o,()=>{console.log("Close comment modal clicked"),I(!1),s(S,null)}),se(3,c,()=>me,()=>({y:100,duration:400})),se(3,t,()=>ze,()=>({duration:300})),l(a,t)};y(fe,a=>{I()&&a(je)})}var u=n(fe,2);{var b=a=>{AuthModal(a,{get show(){return e(q)},set show(t){s(q,t)},$$events:{authSuccess:()=>{console.log("Auth success, refreshing comments"),s(q,!1),ee()},authError:({detail:t})=>{console.log("Auth error:",t.message),s(S,t.message),s(q,!1)}},$$legacy:!0})};y(u,a=>{e(q)&&a(b)})}l(H,_e),Ve(),ke()}var jt=v('<meta name="description" content="A collaborative creative platform for drawing, plotting, selling, and solving challenges." class="svelte-i1vkni">'),$t=v('<div class="loader-container svelte-i1vkni" role="status" aria-live="polite"><div class="loader-overlay svelte-i1vkni"></div> <div class="loader-content svelte-i1vkni"><img src="/logo192.png" alt="Pexos Logo" class="loader-logo floating svelte-i1vkni"> <p class="loader-text svelte-i1vkni">Initializing Pexos...</p></div></div>'),St=v('<div class="svelte-i1vkni"><img src="/logo192.png" alt="Pexos Logo" class="hero-logo svelte-i1vkni"></div>'),At=v('<div class="svelte-i1vkni"><h1 class="hero-title svelte-i1vkni">Pexos</h1></div>'),Et=v('<div class="svelte-i1vkni"><p class="hero-subtitle svelte-i1vkni">A Collaborative Creative Platform</p></div>'),Pt=v('<div class="headline-section svelte-i1vkni"><h2 class="hero-headline svelte-i1vkni"><!> Create, Plot, Sell, and Solve Community Challenges</h2></div>'),Mt=Ie('<path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z" fill="white" class="svelte-i1vkni"></path>'),It=Ie('<path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm4.59-12.42L10 14.17l-2.59-2.58L6 13l4 4 8-8z" fill="white" class="svelte-i1vkni"></path>'),Rt=v('<div class="svelte-i1vkni"><button class="action-button svelte-i1vkni"><span class="button-icon svelte-i1vkni"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" class="svelte-i1vkni"><!></svg></span> </button></div>'),Lt=v('<div class="hero-container svelte-i1vkni"><div><!></div> <div></div> <div></div> <div></div> <div></div> <div class="hero-content svelte-i1vkni"><!> <!> <!> <!> <!></div></div>'),Vt=v('<div class="modal-debug svelte-i1vkni">Auth Modal should be visible</div> <!>',1),Dt=v('<div class="modal-debug svelte-i1vkni">Comment Modal should be visible</div> <!>',1),Tt=v("<!> <!> <!>",1);function aa(H,le){Le(le,!1);const[ye,ke]=Ne(),A=()=>Ue(ct,"$page",ye);let I=w(!1),h=w(!1),R=w(!0),g=w(null),V=w(!1),E=w(!1),X=w(!1),S=w(!1),q=w(!1),re=w(!1);Qe(async()=>{console.log("Root page mounted");try{const{data:{session:u},error:b}=await oe.auth.getSession();b&&console.error("Session check error:",b.message),s(g,u),console.log("Initial session:",e(g)?"User logged in":"No user"),setTimeout(()=>{s(R,!1),setTimeout(()=>s(V,!0),300),setTimeout(()=>s(E,!0),800),setTimeout(()=>s(X,!0),1300),setTimeout(()=>s(S,!0),1800),setTimeout(()=>s(q,!0),2200),setTimeout(()=>s(re,!0),2800)},1e3);const a=A().url.searchParams.get("redirect");a&&(console.log("Redirect param:",a),localStorage.setItem("sb-redirect",decodeURIComponent(a)),e(g)?(console.log("User already signed in, redirecting to:",a),we(decodeURIComponent(a),{replaceState:!0})):(console.log("No session, showing auth modal"),s(I,!0)));const{data:t}=oe.auth.onAuthStateChange(async(c,o)=>{var k;if(console.log("Auth state changed:",c,(k=o==null?void 0:o.user)==null?void 0:k.email),s(g,o),c==="SIGNED_IN"&&o){await Pe();const P=localStorage.getItem("sb-redirect")||"/";localStorage.removeItem("sb-redirect"),console.log("Redirecting after sign-in:",P),we(P,{replaceState:!0})}});return()=>t.subscription.unsubscribe()}catch(u){console.error("Session check failed:",u),s(R,!1)}});function ue(){e(g)?(console.log("User logged in, toggling comment modal"),s(h,!0)):(console.log("No user, showing auth modal"),s(I,!0)),console.log("Modal states:",{showAuthModal:e(I),showCommentModal:e(h)})}Re();var ee=Tt();Ze(u=>{var b=jt();Xe.title="Pexos - Creative Platform",l(u,b)});var pe=ie(ee);{var Ce=u=>{var b=$t();l(u,b)},xe=u=>{var b=Lt(),a=m(b);let t;var c=m(a);tt(c,{}),d(a);var o=n(a,2);let k;var P=n(o,2);let G;var D=n(P,2);let te;var p=n(D,2);let _;var M=n(p,2),J=m(M);{var ne=i=>{var r=St();se(1,r,()=>me,()=>({y:50,duration:1e3})),l(i,r)};y(J,i=>{e(X)&&i(ne)})}var T=n(J,2);{var z=i=>{var r=At();se(1,r,()=>me,()=>({y:50,duration:1e3,delay:200})),l(i,r)};y(T,i=>{e(X)&&i(z)})}var N=n(T,2);{var x=i=>{var r=Et();se(1,r,()=>me,()=>({y:30,duration:800,delay:300})),l(i,r)};y(N,i=>{e(S)&&i(x)})}var f=n(N,2);{var U=i=>{var r=Pt(),C=m(r),F=m(C);{var W=L=>{var Y=Ee();B(()=>Q(Y,`Welcome back, ${e(g).user.email??""}!`)),l(L,Y)},ce=L=>{var Y=Ee("Join the Pexos community and unleash your creativity!");l(L,Y)};y(F,L=>{e(g)?L(W):L(ce,!1)})}De(),d(C),d(r),se(1,r,()=>me,()=>({x:-100,duration:1e3,delay:400})),l(i,r)};y(f,i=>{e(q)&&i(U)})}var ae=n(f,2);{var j=i=>{var r=Rt(),C=m(r),F=m(C),W=m(F),ce=m(W);{var L=$=>{var de=Mt();l($,de)},Y=$=>{var de=It();l($,de)};y(ce,$=>{e(g)?$(L):$(Y,!1)})}d(W),d(F);var he=n(F);d(C),d(r),B(()=>{Te(C,"aria-label",e(g)?"View comments":"Sign in to Pexos"),Q(he,` ${e(g)?"View Comments":"Sign In"}`)}),Z("click",C,ue),Z("keydown",C,$=>($.key==="Enter"||$.key==="Space")&&ue()),se(1,r,()=>ze,()=>({duration:800,delay:500})),l(i,r)};y(ae,i=>{e(re)&&i(j)})}d(M),d(b),B((i,r,C,F,W)=>{t=ve(a,1,"shader-layer svelte-i1vkni",null,t,i),k=ve(o,1,"overlay-layer svelte-i1vkni",null,k,r),G=ve(P,1,"deco-element top-right svelte-i1vkni",null,G,C),te=ve(D,1,"deco-element bottom-left svelte-i1vkni",null,te,F),_=ve(p,1,"deco-element center-glow svelte-i1vkni",null,_,W)},[()=>({active:e(V)}),()=>({"fade-out":e(V)}),()=>({visible:e(E)}),()=>({visible:e(E)}),()=>({visible:e(E)})],be),l(u,b)};y(pe,u=>{e(R)?u(Ce):u(xe,!1)})}var ge=n(pe,2);{var _e=u=>{var b=Vt(),a=n(ie(b),2);at(a,{get show(){return e(I)},set show(t){s(I,t)},$$events:{authSuccess:async()=>{console.log("Auth success event"),await Pe();const t=localStorage.getItem("sb-redirect")||"/";localStorage.removeItem("sb-redirect"),console.log("Redirecting after auth success:",t),we(t,{replaceState:!0})},authError:({detail:t})=>{console.log("Auth error:",t.message),s(I,!1)}},$$legacy:!0}),l(u,b)};y(ge,u=>{e(I)&&u(_e)})}var fe=n(ge,2);{var je=u=>{var b=Dt(),a=n(ie(b),2);xt(a,{get show(){return e(h)},set show(t){s(h,t)},$$legacy:!0}),l(u,b)};y(fe,u=>{e(h)&&u(je)})}l(H,ee),Ve(),ke()}export{aa as component};
