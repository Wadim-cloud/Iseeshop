import"../chunks/CWj6FrbW.js";import"../chunks/69_IOA4Y.js";import{p as K,o as fe,A as U,x as e,G as F,al as S,an as Le,ak as ce,ao as Ie,aq as Z,w as ge,a as Q,at as z,ar as k,au as C,aU as Ae,ap as ue,u as ve}from"../chunks/CgpLTG9e.js";import{e as D,s as re}from"../chunks/C_m-qMmZ.js";import{i as H}from"../chunks/ClXQIVwo.js";import{t as L,a as E}from"../chunks/CVxkZOGS.js";import{i as $}from"../chunks/CKI-jMsq.js";import{p as y}from"../chunks/Bxv1m9ax.js";import{s as Me,b as P,a as J,d as Pe}from"../chunks/CN5En7F1.js";import{w as Y}from"../chunks/4hlrb4d8.js";import{s as V,a as Oe}from"../chunks/BX0sDDBR.js";import{s as he}from"../chunks/CZQXRoan.js";import{b as Re}from"../chunks/Bs1xm8oX.js";import{e as Ue,i as Fe}from"../chunks/B6FZq7_G.js";import{s as je,r as Be}from"../chunks/CvOifuop.js";import{s as ae}from"../chunks/B9RedXCH.js";import{b as Ne}from"../chunks/Dzbni-AY.js";import{C as qe}from"../chunks/D7okP_CL.js";import{T as We}from"../chunks/Ct8AHqA9.js";var Ye=L("<canvas></canvas>");function de(O,i){K(i,!1);let v=y(i,"color",8),h=y(i,"size",8),l=y(i,"canvasStore",8),d=y(i,"disabled",8,!1),r=F(),t=F(),p=!1,n=null;fe(()=>{if(U(t,e(r).getContext("2d")),!e(t)){console.error("Failed to get 2D context");return}return console.log("Canvas bound:",!!e(r)),l()?l().set({canvas:e(r)}):console.warn("canvasStore not provided; canvas not stored"),m(),d()||x(),()=>{window.removeEventListener("resize",m),e(r).removeEventListener("touchstart",w),e(r).removeEventListener("touchmove",w),l()&&l().set({canvas:null})}});function m(){e(r)&&(S(r,e(r).width=window.innerWidth),S(r,e(r).height=window.innerHeight),b())}function b(){e(t)&&(S(t,e(t).fillStyle="white"),e(t).fillRect(0,0,e(r).width,e(r).height))}function w(o){o.preventDefault()}function x(){e(r).addEventListener("touchstart",w,{passive:!1}),e(r).addEventListener("touchmove",w,{passive:!1}),window.addEventListener("resize",m)}function I(o){const u=e(r).getBoundingClientRect();return"touches"in o?{x:o.touches[0].clientX-u.left,y:o.touches[0].clientY-u.top}:{x:o.offsetX,y:o.offsetY}}function j(o){d()||(o.preventDefault(),p=!0,n=I(o),n&&R(n.x,n.y))}function B(o){if(!p||!n||d())return;o.preventDefault();const u=n;n=I(o),e(t)&&(S(t,e(t).lineWidth=h()),S(t,e(t).lineCap="round"),S(t,e(t).strokeStyle=v()),e(t).beginPath(),e(t).moveTo(u.x,u.y),e(t).lineTo(n.x,n.y),e(t).stroke())}function T(o){d()||(o.preventDefault(),p=!1,n=null)}function R(o,u){e(t)&&(S(t,e(t).fillStyle=v()),e(t).beginPath(),e(t).arc(o,u,h()/2,0,Math.PI*2),e(t).fill())}Le(()=>(e(t),ce(v()),ce(h())),()=>{e(t)&&(v()||h())&&(S(t,e(t).strokeStyle=v()),S(t,e(t).lineWidth=h()),S(t,e(t).fillStyle=v()))}),Ie(),$();var g=Ye();let A;Re(g,o=>U(r,o),()=>e(r)),Z(o=>A=he(g,1,"svelte-nqephp",null,A,o),[()=>({disabled:d()})],ge),D("pointerdown",g,j),D("pointermove",g,B),D("pointerup",g,T),D("pointerleave",g,T),E(O,g),Q()}var He=L('<div class="controls svelte-yxtyn0"><button class="control-button svelte-yxtyn0" aria-label="Toggle menu"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svelte-yxtyn0"><circle cx="12" cy="12" r="1"></circle><circle cx="12" cy="5" r="1"></circle><circle cx="12" cy="19" r="1"></circle></svg></button> <button class="control-button svelte-yxtyn0" aria-label="Save drawing"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svelte-yxtyn0"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg></button> <button class="control-button svelte-yxtyn0" aria-label="Go back"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svelte-yxtyn0"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg></button></div>');function Ge(O,i){K(i,!1);let v=y(i,"onSave",8),h=y(i,"onMenuToggle",8),l=y(i,"canvasStore",8),d=null;l().subscribe(b=>{d=b.canvas,console.log("Canvas updated in DrawingControls:",!!d)});function r(){d?v()(d):console.error("Canvas not available")}$();var t=He(),p=z(t),n=k(p,2),m=k(n,2);C(t),D("click",p,function(...b){var w;(w=h())==null||w.apply(this,b)}),D("click",n,r),D("click",m,()=>window.history.back()),E(O,t),Q()}var Xe=L("<button></button>"),Je=L('<div class="advanced-options svelte-lhy0b3"><label class="option svelte-lhy0b3"><input type="checkbox"> Pressure Sensitivity</label> <label class="option svelte-lhy0b3"><input type="checkbox" checked> Smooth Strokes</label></div>'),Ve=L('<div class="menu svelte-lhy0b3"><div class="section svelte-lhy0b3"><h3 class="section-title svelte-lhy0b3">Colors</h3> <div class="color-grid svelte-lhy0b3"></div></div> <div class="section svelte-lhy0b3"><h3 class="section-title svelte-lhy0b3">Brush Size</h3> <div class="slider-container svelte-lhy0b3"><input type="range" min="1" max="50" class="size-slider svelte-lhy0b3"> <span class="size-value svelte-lhy0b3"> </span></div></div> <div class="section svelte-lhy0b3"><button class="advanced-toggle svelte-lhy0b3"> </button> <!></div></div>');function Ze(O,i){K(i,!1);let v=y(i,"colors",8),h=y(i,"selected",8),l=y(i,"size",12),d=y(i,"onColorChange",8),r=y(i,"onSizeChange",8),t=F(!1);$();var p=Ve(),n=z(p),m=k(z(n),2);Ue(m,5,v,Fe,(o,u)=>{var M=Xe();let G;Z(ee=>{G=he(M,1,"color-button svelte-lhy0b3",null,G,ee),ae(M,`background-color: ${e(u)??""}`),je(M,"aria-label",e(u))},[()=>({selected:h()===e(u)})],ge),D("click",M,()=>d()(e(u))),E(o,M)}),C(m),C(n);var b=k(n,2),w=k(z(b),2),x=z(w);Be(x);var I=k(x,2),j=z(I);C(I),C(w),C(b);var B=k(b,2),T=z(B),R=z(T,!0);C(T);var g=k(T,2);{var A=o=>{var u=Je();E(o,u)};H(g,o=>{e(t)&&o(A)})}C(B),C(p),Z(()=>{ae(x,`--thumb-color: ${h()??""}`),ae(I,`color: ${h()??""}`),re(j,`${l()??""}px`),re(R,e(t)?"Hide Advanced":"Show Advanced")}),Ne(x,l),D("input",x,()=>r()(l())),D("click",T,()=>U(t,!e(t))),E(O,p),Q()}var Ke=L("<p>Loading...</p>"),Qe=L("<p> </p>"),$e=L("<!> <!> <!>",1),et=L("<!> <!>",1);function yt(O,i){K(i,!1);const[v,h]=Me(),l=()=>J(n,"$sessionStore",v),d=()=>J(b,"$error",v),r=()=>J(m,"$loading",v),t=()=>J(x,"$toastState",v);let p=y(i,"data",8);const n=Y(p().session),m=Y(!0),b=Y(null),w=Y({canvas:null}),x=Y({message:"",visible:!1,type:"success"}),I=["red","green","blue","black","white"],j="black",B=10,T=3e3;let R=F(j),g=F(B),A=F(!1),o=F(j),u=null,M;fe(async()=>{try{const{data:{session:s}}=await V.auth.getSession();P(n,s||p().session),u=await Oe(),console.log("Create page user:",u),console.log("Create page session:",l()),console.log("Client cookies:",document.cookie);const{data:a}=V.auth.onAuthStateChange((c,f)=>{var _;console.log("Auth state changed:",c,(_=f==null?void 0:f.user)==null?void 0:_.email),P(n,f)});return()=>{a.subscription.unsubscribe()}}catch(s){P(b,s instanceof Error?s.message:"Failed to load session"),console.error("Session sync error:",s)}finally{P(m,!1)}}),Ae(()=>{});const G=s=>s.split("@")[0]||"user";async function ee(s){try{const{count:a,error:c}=await V.from("drawings").select("*",{count:"exact",head:!0}).eq("user_id",s);if(c)throw c;return a||0}catch(a){return console.error("Error fetching drawing count:",a),P(b,"Failed to fetch drawing count"),0}}async function pe(s,a){const c=G(s),f=await ee(a)+1;return`${c}-${f}`}async function me(s){var a;if(!s){q("No canvas element found","error");return}if(!((a=l())!=null&&a.user)){q("Please login to save drawings","error");return}P(m,!0);try{await be(),await we(s),q("Drawing saved successfully!","success")}catch(c){ye(c)}finally{P(m,!1)}}async function be(){var s,a;try{console.log("Fetching rate limit check for user:",(s=l())==null?void 0:s.user.id);const c=await fetch("/api/check-rate-limit",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:(a=l())==null?void 0:a.user.id})});if(!c.ok)throw new Error("Rate limit service unavailable");const f=await c.json();if(f.blocked)throw new Error(f.message||"You are temporarily banned due to excessive submissions");f.limited&&q(f.message||"Warning: approaching submission limit","warning")}catch(c){throw console.error("[Rate Limit]",c),c}}async function we(s){try{const a=s.toDataURL("image/png"),c=new Date().toISOString(),f=await pe(l().user.email,l().user.id),{error:_}=await V.from("drawings").insert({id:crypto.randomUUID(),drawing_id:f,title:"Untitled",image_data:a,user_id:l().user.id,user_email:l().user.email,created_at:c,blocked:!1,likes:0,comments:{}});_&&console.error("Failed to persist drawing:",_)}catch(a){console.error("Unexpected error in persistDrawing:",a)}}function ye(s){const a=s instanceof Error?s.message:"Failed to save drawing";console.error("[DrawingApp] Save error:",s),q(a,"error")}function q(s,a){clearTimeout(M),P(x,{message:s,visible:!0,type:a}),M=setTimeout(()=>{Pe(x,ve(t).visible=!1,ve(t))},T)}function _e(s){U(o,U(R,s))}function xe(s){U(g,Math.max(1,Math.min(50,s)))}function ke(){U(A,!e(A))}$();var ne=et(),ie=ue(ne);{var Se=s=>{var a=Ke();E(s,a)},Ce=(s,a)=>{{var c=_=>{var W=Qe(),te=z(W);C(W),Z(()=>re(te,`Error: ${d()??""}`)),E(_,W)},f=(_,W)=>{{var te=N=>{var X=$e(),se=ue(X);de(se,{get color(){return e(R)},get size(){return e(g)},canvasStore:w});var le=k(se,2);Ge(le,{canvasStore:w,onSave:me,onMenuToggle:ke});var ze=k(le,2);{var Ee=oe=>{Ze(oe,{colors:I,get selected(){return e(o)},get size(){return e(g)},onColorChange:_e,onSizeChange:xe})};H(ze,oe=>{e(A)&&oe(Ee)})}E(N,X)},Te=N=>{qe(N,{message:"You need to log in to start creating",children:(X,se)=>{de(X,{get color(){return e(R)},get size(){return e(g)},disabled:!0})},$$slots:{default:!0}})};H(_,N=>{l()?N(te):N(Te,!1)},W)}};H(s,_=>{d()?_(c):_(f,!1)},a)}};H(ie,s=>{r()?s(Se):s(Ce,!1)})}var De=k(ie,2);We(De,{get message(){return t().message},get show(){return t().visible},get type(){return t().type}}),E(O,ne),Q(),h()}export{yt as component};
