import{t as I,a as P,n as Te,c as be}from"../chunks/B2hSDNwb.js";import{i as ne}from"../chunks/BkJq1j4_.js";import{a2 as Ze,p as le,ay as $e,am as b,al as C,an as v,ak as te,w as _e,x as e,I as Y,a as se,A as i,ax as Pe,o as Ce,aw as ie,ah as Ye,ai as Se,au as Me,ag as de,aj as We,aA as Ne}from"../chunks/Bxdg7ccW.js";import{s as X,e as D,r as Ve,h as Ke}from"../chunks/6og0jn-Y.js";import{g as Je}from"../chunks/IbqXbPHK.js";import{a as ae,s as De}from"../chunks/CP6E_JcI.js";import{i as H}from"../chunks/Bqnn9XxY.js";import{e as ye,i as Le}from"../chunks/ucczKhfM.js";import{p as W}from"../chunks/Czyh_-as.js";import{a as ge}from"../chunks/CcUbZ0dA.js";import{s as Ie}from"../chunks/UMIFvBL3.js";import{l as we,c as Ee,a as Re,b as Qe}from"../chunks/CrH-I_n8.js";import{s as Xe}from"../chunks/ChDf3tN1.js";import{t as ke,a as Be,f as et,s as tt}from"../chunks/CVktCSDB.js";import{b as xe}from"../chunks/C7mBFiPQ.js";import{k as Fe,l as pe,g as at,h as ot,W as rt,c as nt,A as lt,D as Ue,V as Ae,f as st,j as it}from"../chunks/Db2sCihH.js";import{S as ct}from"../chunks/BjVaaCQb.js";import{O as dt}from"../chunks/bDxDMfUK.js";import{b as vt}from"../chunks/cLJjU_P4.js";import{s as mt}from"../chunks/Bfc47y5P.js";import{s as fe}from"../chunks/wkM8Wptt.js";import{u as ut}from"../chunks/Q9OjFAKz.js";import{A as gt}from"../chunks/3YYhwEwk.js";import{w as me}from"../chunks/Cq64pHAR.js";function ft(q,c){var d;var m=(d=q.$$events)==null?void 0:d[c.type],f=Ze(m)?m.slice():m==null?[]:[m];for(var r of f)r.call(this,c)}var ht=Te('<path d="M9 20a1 1 0 100-2 1 1 0 000 2z" fill="#4CAF50"></path><path d="M20 20a1 1 0 100-2 1 1 0 000 2z" fill="#4CAF50"></path><path d="M1 1h4l2.68 13.39a2 2 0 002 1.61h9.72a2 2 0 002-1.61L23 6H6" stroke="#4CAF50"></path>',1),pt=Te('<path d="M9 20a1 1 0 100-2 1 1 0 000 2z"></path><path d="M20 20a1 1 0 100-2 1 1 0 000 2z"></path><path d="M1 1h4l2.68 13.39a2 2 0 002 1.61h9.72a2 2 0 002-1.61L23 6H6"></path>',1),wt=I('<div class="gallery-item svelte-99e3yd"><img class="gallery-image svelte-99e3yd" loading="lazy"> <div class="gallery-meta svelte-99e3yd"><div class="gallery-stats svelte-99e3yd"><button class="like-button svelte-99e3yd"><svg width="20" height="20" viewBox="0 0 24 24" stroke="#333" class="svelte-99e3yd"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"></path></svg> <span> </span></button></div> <div class="drawing-card svelte-99e3yd"><h3 class="svelte-99e3yd"> </h3> <p class="svelte-99e3yd"> </p> <button class="svelte-99e3yd"> </button></div> <div class="button-group svelte-99e3yd"><button class="preview-button svelte-99e3yd"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#333"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg> Preview</button> <button class="preview-button preview-3d svelte-99e3yd"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#333"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"></path><path d="M12 18a6 6 0 100-12 6 6 0 000 12z"></path><path d="M12 14a2 2 0 100-4 2 2 0 000 4z"></path></svg> 3D View</button> <button><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#333"><!></svg> </button> <button class="preview-button comments-button svelte-99e3yd"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#333"><path d="M21 11.5a8.38 8.38 0 01-.9 3.8 8.5 8.5 0 01-7.6 4.7 8.38 8.38 0 01-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 01-.9-3.8 8.5 8.5 0 014.7-7.6 8.38 8.38 0 013.8-.9h.5a8.48 8.48 0 018 8v.5z"></path></svg> </button></div></div></div>');function bt(q,c){le(c,!1);const[m,f]=De(),r=()=>ae(Re,"$cartStore",m),d=()=>ae(we,"$likesStore",m);let o=W(c,"drawing",8),E=W(c,"onLike",8),y=W(c,"onPreview",8),n=W(c,"on3DPreview",8),z=W(c,"onOpenComments",8);$e();let u=Y({});function F(S){console.log("handleLike called with drawingId:",S),i(u,{...e(u),[S]:!e(u)[S]}),E()(S)}function M(S){console.log("handlePreview called with imageData:",S),y()(S)}function _(S){console.log("handle3DPreview called with imageData:",S),n()(S)}function l(S,V){console.log("handleOpenComments called with:",{drawingId:S,drawingUuid:V}),z()(S,V)}const L="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgZmlsbD0iI2VlZSIvPjx0ZXh0IHg9IjUwIiB5PSI1MCIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjgiIGZpbGw9IiNjY2MiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGRvbWluYW50LWJhc2VsaW5lPSJtaWRkbGUiPkxvYWRpbmc8L3RleHQ+PC9zdmc+";function p(S){return r().some(V=>V.drawingId===S)}function x(S){console.log("toggleCartItem called with drawingId:",S.drawing_id),p(S.drawing_id)?Ee.removeFromCart(S.drawing_id):Ee.addToCart(S)}ne();var w=wt(),B=b(w);ge(B,"src",L);var A=C(B,2),s=b(A),t=b(s),k=b(t),G=C(k,2),$=b(G,!0);v(G),v(t),v(s);var Z=C(s,2),U=b(Z),R=b(U,!0);v(U);var h=C(U,2),ee=b(h);v(h);var K=C(h,2),J=b(K);v(K),v(Z);var j=C(Z,2),a=b(j),g=C(a,2),T=C(g,2),N=b(T),O=b(N);{var Q=S=>{var V=ht();Pe(2),P(S,V)},re=S=>{var V=pt();Pe(2),P(S,V)};H(O,S=>{p(o().drawing_id)?S(Q):S(re,!1)})}v(N);var ce=C(N);v(T);var oe=C(T,2),ve=C(b(oe));v(oe),v(j),v(A),v(w),te((S,V,he)=>{var ue;ge(B,"data-src",o().image_data),ge(B,"alt",`User drawing ${o().drawing_id}`),ge(k,"fill",e(u)[o().drawing_id]?"#ff4757":"none"),X($,d()[o().drawing_id]||o().likes||0),X(R,o().drawing_id),X(ee,`Created: ${S??""}`),X(J,`View Comments (${(o().comments||[]).length??""})`),Ie(T,1,`cart-button ${V??""}`,"svelte-99e3yd"),X(ce,` ${he??""}`),X(ve,` Comments (${(((ue=o().comments)==null?void 0:ue.length)||0)??""})`)},[()=>new Date(o().created_at).toLocaleDateString(),()=>p(o().drawing_id)?"in-cart":"",()=>p(o().drawing_id)?"Remove":"Add to Cart"],_e),D("click",B,()=>M(o().image_data)),D("load",B,S=>{const V=S.target;V.dataset.src&&(V.src=V.dataset.src)}),D("click",t,()=>F(o().drawing_id)),D("click",K,()=>l(o().drawing_id,o().id)),D("click",a,()=>M(o().image_data)),D("click",g,()=>_(o().image_data)),D("click",T,()=>x(o())),D("click",oe,()=>l(o().drawing_id,o().id)),P(q,w),se(),f()}var _t=I('<div class="preview-modal svelte-1impoal" role="dialog" aria-modal="true" aria-label="Drawing preview"><div class="preview-content svelte-1impoal"><button class="close-button svelte-1impoal" aria-label="Close preview"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="black" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>  <div class="controls svelte-1impoal"><button aria-label="Zoom out" class="svelte-1impoal"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="black" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="7" y1="11" x2="15" y2="11"></line></svg></button> <button aria-label="Zoom in" class="svelte-1impoal"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="black" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="11" y1="7" x2="11" y2="15"></line><line x1="7" y1="11" x2="15" y2="11"></line></svg></button></div> <div class="image-container svelte-1impoal"><img alt="Drawing preview" class="svelte-1impoal"></div></div></div>');function yt(q,c){le(c,!1);let m=W(c,"imageData",8),f=W(c,"onClose",8),r=Y(),d=Y(),o=Y(1);Ce(()=>{var _;if(console.log("PreviewModal mounted with imageData:",m()),e(r)){(_=e(d))==null||_.focus();const l=e(r).querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'),L=l[0],p=l[l.length-1],x=w=>{w.key==="Tab"&&(w.shiftKey&&document.activeElement===L?(w.preventDefault(),p.focus()):!w.shiftKey&&document.activeElement===p&&(w.preventDefault(),L.focus()))};return e(r).addEventListener("keydown",x),()=>e(r).removeEventListener("keydown",x)}});function E(_){_.key==="Escape"&&f()()}function y(){i(o,Math.min(e(o)+.2,3))}function n(){i(o,Math.max(e(o)-.2,1))}function z(_){_.preventDefault();const l=_.deltaY>0?-.1:.1;i(o,Math.min(Math.max(e(o)+l,1),3))}ne();var u=be(),F=ie(u);{var M=_=>{var l=_t(),L=b(l),p=b(L);xe(p,t=>i(d,t),()=>e(d));var x=C(p,2),w=b(x),B=C(w,2);v(x);var A=C(x,2),s=b(A);v(A),v(L),v(l),xe(l,t=>i(r,t),()=>e(r)),te(()=>{ge(s,"src",m()),Xe(s,`transform: scale(${e(o)??""});`)}),D("click",p,function(...t){var k;(k=f())==null||k.apply(this,t)}),D("keydown",p,t=>(t.key==="Enter"||t.key===" ")&&f()()),D("click",w,n),D("keydown",w,t=>(t.key==="Enter"||t.key===" ")&&n()),D("click",B,y),D("keydown",B,t=>(t.key==="Enter"||t.key===" ")&&y()),ke(3,s,()=>Be,()=>({duration:100})),D("error",s,()=>console.error("Image load error:",m())),D("keydown",l,E),D("wheel",l,z),ke(3,l,()=>Be,()=>({duration:200})),P(_,l)};H(F,_=>{m()&&_(M)})}P(q,u),se()}var kt=I('<p class="error-message svelte-1hfv2po">Error loading 3D model.</p>'),xt=I('<p class="loading-message svelte-1hfv2po">Loading texture...</p>'),Ct=I('<p class="error-message svelte-1hfv2po">Error loading texture.</p>'),Dt=I('<div class="model-container svelte-1hfv2po"><!></div>');function Pt(q,c){le(c,!1);let m=W(c,"drawingData",8),f=W(c,"zoomLevel",8,1),r=Y(),d,o,E=Y(),y,n=Y(),z,u=Y(!1),F=Y(!1),M=Y(!1);function _(){d=new at,o=new ot(75,1,.1,1e3),i(E,new rt({antialias:!0,alpha:!0})),e(E).setSize(e(r).clientWidth,e(r).clientHeight),d.background=new nt(16777215),e(r).appendChild(e(E).domElement),o.position.z=8,y=new dt(o,e(E).domElement),y.enableZoom=!0,y.enablePan=!1,y.minPolarAngle=Math.PI/2,y.maxPolarAngle=Math.PI/2,y.enableDamping=!0,y.dampingFactor=.05,y.autoRotate=!0,y.autoRotateSpeed=.1,y.minDistance=3,y.maxDistance=15;const s=new lt(16777215,.5);d.add(s);const t=new Ue(16777215,.7);t.position.set(1,1,1).normalize(),d.add(t);const k=new Ue(16777215,.3);k.position.set(-1,-1,-1).normalize(),d.add(k)}function l(){console.log("Loading T-shirt model with drawingData:",m()),new ct().load("/models/tshirt.stl",t=>{console.log("STL model loaded successfully"),t.computeBoundingBox();const k=t.boundingBox,G=new Ae;k.getSize(G);const $=t.getAttribute("position"),Z=[],U=$.array;for(let j=0;j<U.length;j+=3){const a=U[j],g=U[j+1];Z.push((a-k.min.x)/G.x,(g-k.min.y)/G.y)}console.log("Generated UVs sample:",Z.slice(0,10)),t.setAttribute("uv",new st(Z,2));let R;if(m()){i(u,!0);const j=new Fe;console.log("Attempting to load texture:",m()),j.load(m(),a=>{console.log("Texture loaded successfully"),a.flipY=!1,a.anisotropy=e(E).capabilities.getMaxAnisotropy(),R=new pe({map:a,color:16777215,specular:1118481,shininess:30}),e(n)&&(de(n,e(n).material=R),de(n,e(n).material.needsUpdate=!0)),i(u,!1)},a=>{console.log("Texture loading progress:",a.loaded/a.total)},a=>{console.error("Texture load error:",a),i(F,!0),i(u,!1),R=new pe({color:16777215}),e(n)&&(de(n,e(n).material=R),de(n,e(n).material.needsUpdate=!0))})}else console.warn("No drawingData provided, using default material"),R=new pe({color:16777215,specular:1118481,shininess:30});i(n,new it(t,R)),t.computeBoundingBox();const h=new Ae;k.getCenter(h),e(n).position.sub(h),e(n).scale.set(f(),f(),f()),d.add(e(n));const ee=t.boundingBox,K=new Ae;ee.getSize(K);const J=Math.max(K.x,K.y,K.z);(J>10||J<.1)&&(o.position.z=Math.max(J*2,8),y.minDistance=o.position.z*.5,y.maxDistance=o.position.z*2),L()},t=>{console.log("Model loading progress:",t.loaded/t.total)},t=>{console.error("STL load error:",t),i(M,!0)})}function L(){z=requestAnimationFrame(L),e(n)&&e(n).scale.set(f(),f(),f()),y.update(),e(E).render(d,o)}function p(){const s=e(r).clientWidth,t=e(r).clientHeight;e(E).setSize(s,t),o.aspect=s/t,o.updateProjectionMatrix()}Ce(()=>(console.log("TshirtModel mounted with drawingData:",m()),_(),l(),window.addEventListener("resize",p),p(),()=>{var s;window.removeEventListener("resize",p),cancelAnimationFrame(z),e(r)&&e(E).domElement&&e(r).removeChild(e(E).domElement),e(E).dispose(),(s=e(n))!=null&&s.material&&(Array.isArray(e(n).material)?e(n).material.forEach(t=>t.dispose()):e(n).material.dispose())})),Ye(()=>{e(n)&&d.remove(e(n))}),Se(()=>(Me(f()),e(n)),()=>{f()&&e(n)&&e(n).scale.set(f(),f(),f())}),Se(()=>(Me(m()),e(n),e(E)),()=>{if(m()&&e(n)){i(u,!0);const s=new Fe;console.log("Reactive texture update for drawingData:",m()),s.load(m(),t=>{console.log("Texture updated successfully"),t.flipY=!1,t.anisotropy=e(E).capabilities.getMaxAnisotropy();const k=new pe({map:t,color:16777215,specular:1118481,shininess:30});de(n,e(n).material=k),de(n,e(n).material.needsUpdate=!0),i(u,!1)},t=>{console.log("Texture update progress:",t.loaded/t.total)},t=>{console.error("Texture update error:",t),i(F,!0),i(u,!1),de(n,e(n).material=new pe({color:16777215})),de(n,e(n).material.needsUpdate=!0)})}}),We(),ne();var x=Dt(),w=b(x);{var B=s=>{var t=kt();P(s,t)},A=(s,t)=>{{var k=$=>{var Z=xt();P($,Z)},G=($,Z)=>{{var U=R=>{var h=Ct();P(R,h)};H($,R=>{e(F)&&R(U)},Z)}};H(s,$=>{e(u)?$(k):$(G,!1)},t)}};H(w,s=>{e(M)?s(B):s(A,!1)})}v(x),xe(x,s=>i(r,s),()=>e(r)),P(q,x),se()}var Mt=I('<div class="preview-modal svelte-kvavg0" role="dialog" aria-modal="true" aria-label="3D T-shirt preview"><div class="preview-content svelte-kvavg0"><button class="close-button svelte-kvavg0" aria-label="Close preview"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="black" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button> <div class="controls svelte-kvavg0"><button aria-label="Zoom out" class="svelte-kvavg0"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="black" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="7" y1="11" x2="15" y2="11"></line></svg></button> <button aria-label="Zoom in" class="svelte-kvavg0"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="black" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="11" y1="7" x2="11" y2="15"></line><line x1="7" y1="11" x2="15" y2="11"></line></svg></button></div> <div class="model-container svelte-kvavg0"><!></div></div></div>');function Lt(q,c){le(c,!1);let m=W(c,"imageData",8),f=W(c,"onClose",8),r=Y(),d=Y(),o=Y(1);Ce(()=>{var _;if(console.log("TshirtPreviewModal mounted with imageData:",m()),e(r)){(_=e(d))==null||_.focus();const l=e(r).querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'),L=l[0],p=l[l.length-1],x=w=>{w.key==="Tab"&&(w.shiftKey&&document.activeElement===L?(w.preventDefault(),p.focus()):!w.shiftKey&&document.activeElement===p&&(w.preventDefault(),L.focus()))};return e(r).addEventListener("keydown",x),()=>e(r).removeEventListener("keydown",x)}});function E(_){_.key==="Escape"&&f()()}function y(){i(o,Math.min(e(o)+.2,3))}function n(){i(o,Math.max(e(o)-.2,1))}function z(_){_.preventDefault();const l=_.deltaY>0?-.1:.1;i(o,Math.min(Math.max(e(o)+l,1),3))}ne();var u=be(),F=ie(u);{var M=_=>{var l=Mt(),L=b(l),p=b(L);xe(p,t=>i(d,t),()=>e(d));var x=C(p,2),w=b(x),B=C(w,2);v(x);var A=C(x,2),s=b(A);Pt(s,{get drawingData(){return m()},get zoomLevel(){return e(o)}}),v(A),v(L),v(l),xe(l,t=>i(r,t),()=>e(r)),D("click",p,function(...t){var k;(k=f())==null||k.apply(this,t)}),D("keydown",p,t=>(t.key==="Enter"||t.key===" ")&&f()()),D("click",w,n),D("keydown",w,t=>(t.key==="Enter"||t.key===" ")&&n()),D("click",B,y),D("keydown",B,t=>(t.key==="Enter"||t.key===" ")&&y()),D("keydown",l,E),D("wheel",l,z),ke(3,l,()=>Be,()=>({duration:200})),P(_,l)};H(F,_=>{m()&&_(M)})}P(q,u),se()}var Et=I("<p>Loading comments...</p>"),zt=I('<p class="error svelte-10mb2nl"> </p> <button class="retry-button svelte-10mb2nl">Retry</button>',1),At=I("<p>No comments yet. Be the first to comment!</p>"),St=I('<div class="comment svelte-10mb2nl"><p class="svelte-10mb2nl"><strong class="username svelte-10mb2nl"> </strong> </p> <small class="svelte-10mb2nl"> </small></div>'),It=I('<div class="comments-list svelte-10mb2nl"></div>'),Bt=I('<div class="comment-form svelte-10mb2nl"><textarea placeholder="Add a comment..." rows="4" class="svelte-10mb2nl"></textarea> <button class="comment-button svelte-10mb2nl">Post Comment</button></div>'),Gt=I('<p>Please <button class="link-button svelte-10mb2nl">log in</button> to post a comment.</p>'),Ft=I('<div class="modal-overlay svelte-10mb2nl"><div class="modal-content svelte-10mb2nl"><button class="close-button svelte-10mb2nl">×</button> <h2 class="svelte-10mb2nl"> </h2> <!> <!></div></div> <!>',1);function Ut(q,c){var K,J,j;le(c,!1);const[m,f]=De(),r=()=>ae(ut,"$user",m);let d=W(c,"id",8),o=W(c,"drawing_id",8),E=W(c,"onClose",8),y=Y([]),n=Y(""),z=Y(!1),u=Y(null),F=Y(!1);!d()||!o()?(i(u,"Invalid drawing ID or UUID"),console.error("CommentsModal mounted with invalid props:",{id:d(),drawing_id:o()})):console.log("CommentsModal mounted with props:",{id:d(),drawing_id:o(),idLength:(K=d())==null?void 0:K.length,userId:(J=r())==null?void 0:J.id,userEmail:(j=r())==null?void 0:j.email});function M(a,g){return r()&&r().id===a&&r().email?r().email.split("@")[0]:(g==null?void 0:g.split("@")[0])||a.slice(0,8)}function _(a,g){return"user"in a?{user_id:a.user,content:a.text,created_at:g,display_name:a.user.slice(0,8)}:a}async function l(){if(!d()||!o()){i(u,"Cannot load comments: Missing drawing ID or UUID"),console.error("fetchComments called with invalid props:",{id:d(),drawing_id:o()});return}i(z,!0),i(u,null),console.log("Fetching comments for UUID:",d(),"drawing_id:",o());try{const{data:a,error:g}=await fe.from("drawings").select("comments, user_email, created_at").eq("id",d()).single();if(g)i(u,`Failed to load comments: Drawing ${o()} not found`),console.error("Error fetching comments:",g),i(y,[]);else{console.log("Fetched data:",{uuid:d(),public_drawing_id:o(),comments:a==null?void 0:a.comments,user_email:a==null?void 0:a.user_email});const T=Array.isArray(a==null?void 0:a.comments)?a.comments:[],N=(a==null?void 0:a.created_at)||new Date().toISOString();i(y,T.map(O=>{const Q=_(O,N);return{...Q,display_name:M(Q.user_id,a.user_email)}})),console.log("Processed comments:",e(y))}}catch(a){i(u,`Unexpected error loading comments: ${a.message}`),console.error("Unexpected error in fetchComments:",a),i(y,[])}i(z,!1)}async function L(){var a;if(!(!r()||!e(n).trim())){if(!d()||!o()){i(u,"Cannot post comment: Missing drawing ID or UUID"),console.error("postComment called with invalid props:",{id:d(),drawing_id:o()});return}i(z,!0),i(u,null);try{const g={user_id:r().id,content:e(n).trim(),created_at:new Date().toISOString(),display_name:((a=r().email)==null?void 0:a.split("@")[0])||r().id.slice(0,8)},{data:T,error:N}=await fe.from("drawings").select("comments").eq("id",d()).single();if(N)throw new Error(`Failed to fetch current comments: ${N.message}`);const O=Array.isArray(T==null?void 0:T.comments)?T.comments:[],Q=[...O,g];console.log("Update payload:",{id:d(),currentComments:O.length,updatedComments:Q.length});const{data:re,error:ce}=await fe.from("drawings").update({comments:Q}).eq("id",d()).select();if(ce)throw new Error(`Failed to update comments: ${ce.message}`);console.log("Update successful:",re),i(n,""),await l()}catch(g){i(u,`Error: ${g.message}`),console.error("Error posting comment:",g)}i(z,!1)}}function p(){localStorage.setItem("sb-redirect",window.location.pathname),i(F,!0)}Ce(()=>{var a,g;console.log("CommentsModal mounted. Authenticated user ID:",(a=r())==null?void 0:a.id,"Email:",(g=r())==null?void 0:g.email),d()&&o()?l().catch(T=>{console.error("Error in onMount fetchComments:",T),i(u,`Failed to initialize comments: ${T.message}`)}):console.error("onMount skipped due to invalid props:",{id:d(),drawing_id:o()})}),ne();var x=Ft(),w=ie(x),B=b(w),A=b(B),s=C(A,2),t=b(s);v(s);var k=C(s,2);{var G=a=>{var g=Et();P(a,g)},$=(a,g)=>{{var T=O=>{var Q=zt(),re=ie(Q),ce=b(re,!0);v(re);var oe=C(re,2);te(()=>X(ce,e(u))),D("click",oe,l),P(O,Q)},N=(O,Q)=>{{var re=oe=>{var ve=At();P(oe,ve)},ce=oe=>{var ve=It();ye(ve,5,()=>e(y),Le,(S,V)=>{var he=St(),ue=b(he),ze=b(ue),je=b(ze,!0);v(ze);var qe=C(ze);v(ue);var Ge=C(ue,2),Oe=b(Ge,!0);v(Ge),v(he),te(He=>{X(je,e(V).display_name||"User"),X(qe,`: ${e(V).content??""}`),X(Oe,He)},[()=>new Date(e(V).created_at).toLocaleString()],_e),P(S,he)}),v(ve),P(oe,ve)};H(O,oe=>{e(y).length===0?oe(re):oe(ce,!1)},Q)}};H(a,O=>{e(u)?O(T):O(N,!1)},g)}};H(k,a=>{e(z)?a(G):a($,!1)})}var Z=C(k,2);{var U=a=>{var g=Bt(),T=b(g);Ve(T);var N=C(T,2);v(g),te(O=>{T.disabled=e(z),N.disabled=O},[()=>e(z)||!e(n).trim()],_e),vt(T,()=>e(n),O=>i(n,O)),D("click",N,L),P(a,g)},R=a=>{var g=Gt(),T=C(b(g));Pe(),v(g),D("click",T,p),P(a,g)};H(Z,a=>{r()?a(U):a(R,!1)})}v(B),v(w);var h=C(w,2);{var ee=a=>{gt(a,{get show(){return e(F)},set show(g){i(F,g)},$$events:{authSuccess:()=>{i(F,!1),l()},authError:({detail:g})=>{i(u,g.message),i(F,!1)}},$$legacy:!0})};H(h,a=>{e(F)&&a(ee)})}te(()=>X(t,`Comments for Drawing #${o()||"Unknown"}`)),D("click",A,function(...a){var g;(g=E())==null||g.apply(this,a)}),D("click",B,mt(function(a){ft.call(this,c,a)})),D("click",w,function(...a){var g;(g=E())==null||g.apply(this,a)}),P(q,x),se(),f()}var Tt=I('<div class="loading svelte-9bc2at">Loading gallery...</div>'),$t=I('<div class="error svelte-9bc2at"> </div>'),Wt=I('<div class="no-content svelte-9bc2at">No drawings available.</div>'),Rt=I('<div class="gallery-grid svelte-9bc2at"></div>'),jt=I('<div class="gallery-wrapper svelte-9bc2at"><!> <!> <!> <!></div>');function qt(q,c){le(c,!1);const[m,f]=De(),r=()=>ae(z,"$selectedDrawing",m),d=()=>ae(u,"$selected3DDrawing",m);let o=W(c,"drawings",8),E=W(c,"loading",8),y=W(c,"error",8),n=W(c,"onLike",8);W(c,"onPageChange",8);const z=me(null),u=me(null);let F=Y(null),M=Y(null);function _(h){console.log("GalleryGrid handlePreview setting selectedDrawing:",h),z.set(h)}function l(){console.log("GalleryGrid handleClosePreview resetting selectedDrawing"),z.set(null)}function L(h){console.log("GalleryGrid handle3DPreview setting selected3DDrawing:",h),u.set(h)}function p(){console.log("GalleryGrid handleClose3DPreview resetting selected3DDrawing"),u.set(null)}function x(h,ee){console.log("GalleryGrid handleOpenComments setting IDs:",{drawingId:h,drawingUuid:ee}),i(F,ee),i(M,h)}function w(){console.log("GalleryGrid handleCloseComments resetting IDs"),i(F,null),i(M,null)}ne();var B=jt(),A=b(B);{var s=h=>{var ee=Tt();P(h,ee)},t=(h,ee)=>{{var K=j=>{var a=$t(),g=b(a,!0);v(a),te(()=>X(g,y())),P(j,a)},J=(j,a)=>{{var g=N=>{var O=Wt();P(N,O)},T=N=>{var O=Rt();ye(O,5,o,Q=>Q.drawing_id,(Q,re)=>{bt(Q,{get drawing(){return e(re)},get onLike(){return n()},onPreview:_,on3DPreview:L,onOpenComments:x})}),v(O),P(N,O)};H(j,N=>{o().length===0?N(g):N(T,!1)},a)}};H(h,j=>{y()?j(K):j(J,!1)},ee)}};H(A,h=>{E()?h(s):h(t,!1)})}var k=C(A,2);{var G=h=>{yt(h,{get imageData(){return r()},onClose:l})};H(k,h=>{r()&&h(G)})}var $=C(k,2);{var Z=h=>{Lt(h,{get imageData(){return d()},onClose:p})};H($,h=>{d()&&h(Z)})}var U=C($,2);{var R=h=>{Ut(h,{get id(){return e(F)},get drawing_id(){return e(M)},onClose:w})};H(U,h=>{e(F)&&e(M)&&h(R)})}v(B),P(q,B),se(),f()}var Ot=I("<button></button>"),Ht=I('<span class="svelte-1hgqvg2">…</span>'),Zt=I("<!> <button> </button>",1),Yt=I('<nav class="pagination svelte-1hgqvg2"><button aria-label="Previous Page" class="svelte-1hgqvg2">◀ Prev</button> <!> <button aria-label="Next Page" class="svelte-1hgqvg2">Next ▶</button></nav>');function Nt(q,c){le(c,!1);const m=Y();let f=W(c,"currentPage",8,1),r=W(c,"totalPages",8,1);const d=$e(),o=M=>{M>=1&&M<=r()&&M!==f()&&d("pageChange",M)};Se(()=>(Me(r()),Me(f())),()=>{i(m,(()=>{if(r()<=7)return Array.from({length:r()},(_,l)=>l+1);const M=new Set;return M.add(1),M.add(r()),f()>1&&M.add(f()-1),M.add(f()),f()<r()&&M.add(f()+1),Array.from(M).sort((_,l)=>_-l)})())}),We(),ne();var E=Yt(),y=b(E),n=C(y,2);{var z=M=>{var _=be(),l=ie(_);ye(l,1,()=>Array(r()),Le,(L,p,x)=>{var w=Ot();let B;w.textContent=x+1,te(A=>B=Ie(w,1,"svelte-1hgqvg2",null,B,A),[()=>({selected:x+1===f()})],_e),D("click",w,()=>o(x+1)),P(L,w)}),P(M,_)},u=M=>{var _=be(),l=ie(_);ye(l,1,()=>e(m),Le,(L,p,x)=>{var w=Zt(),B=ie(w);{var A=G=>{var $=Ht();P(G,$)};H(B,G=>{x>0&&e(p)-e(m)[x-1]>1&&G(A)})}var s=C(B,2);let t;var k=b(s,!0);v(s),te(G=>{t=Ie(s,1,"svelte-1hgqvg2",null,t,G),X(k,e(p))},[()=>({selected:e(p)===f()})],_e),D("click",s,()=>o(e(p))),P(L,w)}),P(M,_)};H(n,M=>{r()<=7?M(z):M(u,!1)})}var F=C(n,2);v(E),te(()=>{y.disabled=f()===1,F.disabled=f()===r()}),D("click",y,()=>o(f()-1)),D("click",F,()=>o(f()+1)),P(q,E),se()}var Vt=I('<div class="gallery-controls svelte-19aqbvt"><!></div>');function Kt(q,c){le(c,!1);let m=W(c,"currentPage",8),f=W(c,"totalPages",8),r=W(c,"onPageChange",8);ne();var d=be(),o=ie(d);{var E=y=>{var n=Vt(),z=b(n);Nt(z,{get currentPage(){return m()},get totalPages(){return f()},$$events:{pageChange:u=>r()(u.detail)}}),v(n),P(y,n)};H(o,y=>{f()>1&&y(E)})}P(q,d),se()}var Jt=I('<span class="cart-badge svelte-13mh0ai"> </span>'),Qt=I('<div class="empty-cart svelte-13mh0ai"><p>Your cart is empty</p> <p class="empty-caption svelte-13mh0ai">Add drawings to create custom 3D objects</p></div>'),Xt=I('<div class="cart-item svelte-13mh0ai"><img alt="Drawing preview" class="cart-thumbnail svelte-13mh0ai"> <button class="remove-button svelte-13mh0ai"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M18 6L6 18M6 6l12 12"></path></svg></button></div>'),ea=I('<div class="cart-items svelte-13mh0ai"></div> <div class="cart-footer svelte-13mh0ai"><button class="clear-button svelte-13mh0ai">Clear All</button> <button class="checkout-button svelte-13mh0ai"> <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M5 12h14M12 5l7 7-7 7"></path></svg></button></div>',1),ta=I('<div class="cart-panel svelte-13mh0ai"><div class="cart-header svelte-13mh0ai"><h3 class="svelte-13mh0ai"> </h3> <button class="close-button svelte-13mh0ai">×</button></div> <!></div>'),aa=I('<div class="cart-container svelte-13mh0ai"><button class="cart-button svelte-13mh0ai"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="9" cy="21" r="1"></circle><circle cx="20" cy="21" r="1"></circle><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path></svg> <!></button> <!></div>');function oa(q,c){le(c,!1);const[m,f]=De(),r=()=>ae(Qe,"$cartSize",m),d=()=>ae(Re,"$cartStore",m);let o=W(c,"showCart",12,!1);function E(){o(!o())}function y(L){Ee.removeFromCart(L)}function n(){o(!1),Je("/gallery/checkout")}ne();var z=aa(),u=b(z),F=C(b(u),2);{var M=L=>{var p=Jt(),x=b(p,!0);v(p),te(()=>X(x,r())),P(L,p)};H(F,L=>{r()>0&&L(M)})}v(u);var _=C(u,2);{var l=L=>{var p=ta(),x=b(p),w=b(x),B=b(w);v(w);var A=C(w,2);v(x);var s=C(x,2);{var t=G=>{var $=Qt();P(G,$)},k=G=>{var $=ea(),Z=ie($);ye(Z,5,d,Le,(K,J)=>{var j=Xt(),a=b(j),g=C(a,2);v(j),te(()=>ge(a,"src",e(J).imageData)),D("click",g,()=>y(e(J).drawingId)),ke(3,j,()=>tt),P(K,j)}),v(Z);var U=C(Z,2),R=b(U),h=C(R,2),ee=b(h);Pe(),v(h),v(U),te(()=>X(ee,`Checkout (${r()??""}) `)),D("click",R,function(...K){var J;(J=Ee.clearCart)==null||J.apply(this,K)}),D("click",h,n),P(G,$)};H(s,G=>{r()===0?G(t):G(k,!1)})}v(p),te(()=>X(B,`Your Cart (${r()??""})`)),D("click",A,E),ke(3,p,()=>et,()=>({y:-20,duration:200})),P(L,p)};H(_,L=>{o()&&L(l)})}v(z),D("click",u,E),P(q,z),se(),f()}var ra=I('<div class="gallery-container svelte-np1y62"><!> <!> <!></div>');function na(q,c){le(c,!1);const[m,f]=De(),r=()=>ae(_,"$pagination",m),d=()=>ae(we,"$likesStore",m),o=()=>ae(z,"$drawings",m),E=()=>ae(F,"$loading",m),y=()=>ae(u,"$error",m),n=()=>ae(M,"$showCart",m),z=me([]),u=me(null),F=me(!1),M=me(!1),_=me({currentPage:1,totalPages:1,itemsPerPage:42});async function l(A){F.set(!0),u.set(null);const{itemsPerPage:s}=r(),t=(A-1)*s;try{const{data:k,count:G,error:$}=await fe.from("drawings").select("id, drawing_id, image_data, likes, created_at, comments, user_id, user_email, blocked",{count:"exact"}).order("created_at",{ascending:!1}).range(t,t+s-1);if($)throw $;const Z=await Promise.all((k||[]).map(async U=>{if(console.log("Fetched drawing:",{id:U.id,drawing_id:U.drawing_id}),U.image_data.startsWith("drawings/")){const{data:R,error:h}=await fe.storage.from("drawings").createSignedUrl(U.image_data,3600);return h?(console.error("Signed URL error:",h),U):{...U,image_data:R.signedUrl}}return U}));z.set(Z),_.update(U=>({...U,currentPage:A,totalPages:Math.ceil((G||0)/s)})),we.update(U=>{const R={...U};return Z.forEach(h=>R[h.drawing_id]=h.likes),R})}catch(k){u.set(k instanceof Error?k.message:"Failed to load drawings"),console.error("Gallery error:",k)}finally{F.set(!1)}}async function L(A){console.log("GalleryContainer handleLike called with drawingId:",A);const s=d()[A]||0;we.update(t=>({...t,[A]:s+1})),z.update(t=>t.map(k=>k.drawing_id===A?{...k,likes:s+1}:k));try{await fe.from("drawings").update({likes:s+1}).eq("drawing_id",A).throwOnError()}catch(t){console.error("Like update failed:",t),we.update(k=>({...k,[A]:s})),z.update(k=>k.map(G=>G.drawing_id===A?{...G,likes:s}:G)),u.set("Failed to update like. Please try again.")}}Ce(()=>{l(1)}),ne();var p=ra(),x=b(p);qt(x,{get drawings(){return o()},get loading(){return E()},get error(){return y()},onLike:L,onPageChange:l});var w=C(x,2);Kt(w,{get currentPage(){return r().currentPage},get totalPages(){return r().totalPages},onPageChange:l});var B=C(w,2);oa(B,{get showCart(){return n()}}),v(p),P(q,p),se(),f()}var la=I('<meta name="description" content="Browse community creations">');function Aa(q){Ke(c=>{var m=la();Ne.title="Gallery | Pexos",P(c,m)}),na(q,{})}export{Aa as component};
