import"../chunks/CWj6FrbW.js";import"../chunks/69_IOA4Y.js";import{p as j,a as J,au as c,at as m,ar as d,aq as H,x as o,o as ae,am as te,A as h,G as D,w as $}from"../chunks/CgpLTG9e.js";import{s as G,e as U,r as N}from"../chunks/C_m-qMmZ.js";import{e as I,i as O}from"../chunks/B6FZq7_G.js";import{t as P,a as T}from"../chunks/CVxkZOGS.js";import{b as Q}from"../chunks/Dzbni-AY.js";import{i as K}from"../chunks/CKI-jMsq.js";import{s as l}from"../chunks/BEUgLf7p.js";import{r as se,a as ne}from"../chunks/CvOifuop.js";import{c as ie,t as de}from"../chunks/sPbp32sz.js";import{p as z}from"../chunks/Bxv1m9ax.js";function le(n){return--n*n*n*n*n+1}const[ce,De]=ie({duration:n=>Math.sqrt(n*200),fallback(n,g){const s=getComputedStyle(n),f=s.transform==="none"?"":s.transform;return{duration:600,easing:le,css:u=>`
				transform: ${f} scale(${u});
				opacity: ${u}
			`}}});var ue=P('<li class="svelte-1dl020x"><input type="checkbox" class="svelte-1dl020x"> <span> </span> <button aria-label="Remove" class="svelte-1dl020x"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" class="svelte-1dl020x"><path fill="#888" stroke="none" d="M22 4.2h-5.6L15 1.6c-.1-.2-.4-.4-.7-.4H9.6c-.2 0-.5.2-.6.4L7.6 4.2H2c-.4 0-.8.4-.8.8s.4.8.8.8h1.8V22c0 .4.3.8.8.8h15c.4 0 .8-.3.8-.8V5.8H22c.4 0 .8-.3.8-.8s-.4-.8-.8-.8zM10.8 16.5c0 .4-.3.8-.8.8s-.8-.3-.8-.8V10c0-.4.3-.8.8-.8s.8.3.8.8v6.5zm4 0c0 .4-.3.8-.8.8s-.8-.3-.8-.8V10c0-.4.3-.8.8-.8s.8.3.8.8v6.5z" class="svelte-1dl020x"></path></svg></button></li>'),he=P('<ul class="svelte-1dl020x"></ul>');function C(n,g){j(g,!1);let s=z(g,"todos",24,()=>[]),f=z(g,"onToggleDone",8),u=z(g,"onRemove",8);K();var v=he();I(v,5,s,i=>i.id,(i,p)=>{var _=ue(),x=m(_);se(x);var y=d(x,2),E=m(y,!0);c(y);var A=d(y,2);c(_),H(()=>{ne(x,o(p).done),G(E,o(p).description)}),U("change",x,()=>f()(o(p))),U("click",A,()=>u()(o(p))),de(3,_,()=>ce),T(i,_)}),c(v),T(n,v),J()}var me=P('<div><p class="svelte-dn77k5"> </p> <!></div>'),ve=P('<button class="svelte-dn77k5"> </button>'),fe=P('<div class="board svelte-dn77k5"><textarea placeholder="What needs to be done?" rows="1" class="todo-input svelte-dn77k5"></textarea> <div class="todo"><h2 class="svelte-dn77k5">My Tasks - Todo</h2> <!></div> <div class="done"><h2 class="svelte-dn77k5">My Tasks - Done</h2> <!></div> <div class="shared svelte-dn77k5"><h2 class="svelte-dn77k5">Shared with Me</h2> <!></div> <div class="share svelte-dn77k5"><h2 class="svelte-dn77k5">Share a Task</h2> <textarea placeholder="Who do you want to share with? (email)" rows="1" class="email-input svelte-dn77k5"></textarea> <!></div></div>');function Ue(n,g){j(g,!1);let s=D([]),f=D([]),u=D(""),v=D(""),i;ae(async()=>{const{data:{user:e}}=await l.auth.getUser();i=e,i&&(await p(),await _(),l.channel("todos").on("postgres_changes",{event:"*",schema:"public",table:"todos",filter:`user_id=eq.${i.id}`},p).on("postgres_changes",{event:"*",schema:"public",table:"shared_todos",filter:`shared_with_user_id=eq.${i.id}`},_).subscribe())}),te(()=>{l.removeAllChannels()});async function p(){const{data:e,error:r}=await l.from("todos").select("*").eq("user_id",i.id).order("id",{ascending:!0});if(r){console.error("Error fetching todos:",r.message);return}h(s,e||[])}async function _(){const{data:e,error:r}=await l.rpc("get_shared_todos",{p_user_id:i.id});if(r){console.error("Error fetching shared todos:",r.message);return}h(f,e?e.map(t=>({...t,shared_by_email:t.shared_by_email||"Unknown"})):[])}async function x(){if(!o(u).trim()){alert("Please enter a todo description.");return}try{const{data:e,error:r}=await l.from("todos").insert([{description:o(u).trim(),done:!1,user_id:i.id}]).select();if(r){console.error("Error adding todo:",r.message),alert("Failed to add todo. Please try again.");return}Array.isArray(e)&&h(s,[...o(s),...e]),h(u,"")}catch(e){console.error("Unexpected error while adding todo:",e),alert("An unexpected error occurred. Please try again.")}}async function y(e,r=!1){try{const{error:t}=await l.from("todos").update({done:!e.done}).eq("id",e.id);if(t){console.error("Error updating todo:",t.message),alert("Failed to update todo. Please try again.");return}r?h(f,o(f).map(a=>a.id===e.id?{...a,done:!a.done}:a)):h(s,o(s).map(a=>a.id===e.id?{...a,done:!a.done}:a))}catch(t){console.error("Unexpected error while updating todo:",t),alert("An unexpected error occurred. Please try again.")}}async function E(e){try{const{error:r}=await l.from("todos").delete().eq("id",e.id).eq("user_id",i.id);if(r){console.error("Error deleting todo:",r.message),alert("Failed to delete todo. Please try again.");return}h(s,o(s).filter(t=>t.id!==e.id))}catch(r){console.error("Unexpected error while deleting todo:",r),alert("An unexpected error occurred. Please try again.")}}async function A(e){if(!o(v).trim()){alert("Please enter an email to share with.");return}try{const r=o(v).trim().toLowerCase();if(console.log("Attempting to share with email:",r),!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(r)){console.error("Invalid email format:",r),alert("Please enter a valid email address.");return}const{data:a,error:w}=await l.from("collaborators").select("id").ilike("email",r);if(console.log("Query result:",{sharedUsers:a,userError:w}),w){console.error("Error querying collaborators:",w.message),alert("Error finding user. Please try again.");return}if(!a||a.length===0){console.error("No user found for email:",r),alert("User not found. Please check the email.");return}if(a.length>1){console.error("Multiple users found for email:",r,a),alert("Multiple users found with this email. Please contact support.");return}const b=a[0];console.log("Found user ID:",b.id);const{data:V,error:k}=await l.from("shared_todos").select("id").eq("todo_id",e.id).eq("shared_with_user_id",b.id).single();if(V){alert("This todo is already shared with this user.");return}if(k&&k.code!=="PGRST116"){console.error("Error checking existing share:",k.message),alert("Failed to check existing shares. Please try again.");return}const{error:B}=await l.from("shared_todos").insert({todo_id:e.id,shared_with_user_id:b.id,shared_by_user_id:i.id});if(B){console.error("Error sharing todo:",B.message),alert("Failed to share todo. Please try again.");return}alert("Todo shared successfully!"),h(v,"")}catch(r){console.error("Unexpected error while sharing todo:",r),alert("An unexpected error occurred. Please try again.")}}K();var M=fe(),q=m(M);N(q);var R=d(q,2),X=d(m(R),2);const Y=$(()=>o(s).filter(e=>!e.done));C(X,{get todos(){return o(Y)},onToggleDone:y,onRemove:E}),c(R);var S=d(R,2),Z=d(m(S),2);const ee=$(()=>o(s).filter(e=>e.done));C(Z,{get todos(){return o(ee)},onToggleDone:y,onRemove:E}),c(S);var F=d(S,2),re=d(m(F),2);I(re,1,()=>o(f),O,(e,r)=>{var t=me(),a=m(t),w=m(a);c(a);var b=d(a,2);const V=$(()=>[o(r)]);C(b,{get todos(){return o(V)},onToggleDone:k=>y(k,!0),onRemove:()=>{}}),c(t),H(()=>G(w,`Shared by: ${o(r).shared_by_email??""}`)),T(e,t)}),c(F);var W=d(F,2),L=d(m(W),2);N(L);var oe=d(L,2);I(oe,1,()=>o(s),O,(e,r)=>{var t=ve(),a=m(t);c(t),H(()=>G(a,`Share: ${o(r).description??""}`)),U("click",t,()=>A(o(r))),T(e,t)}),c(W),c(M),Q(q,()=>o(u),e=>h(u,e)),U("keydown",q,e=>{e.key==="Enter"&&(e.preventDefault(),x())}),Q(L,()=>o(v),e=>h(v,e)),T(n,M),J()}export{Ue as component};
