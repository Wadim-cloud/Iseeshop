import"../chunks/CWj6FrbW.js";import"../chunks/69_IOA4Y.js";import{p as Q,o as fe,A as B,x as e,G as F,al as x,an as Ee,ak as ce,ao as Le,aq as G,w as ge,a as K,at as z,ar as _,au as k,aU as Ne,ap as ue,u as de}from"../chunks/CgpLTG9e.js";import{e as C,s as oe}from"../chunks/C_m-qMmZ.js";import{i as Z}from"../chunks/ClXQIVwo.js";import{t as T,a as D}from"../chunks/CVxkZOGS.js";import{i as $}from"../chunks/CKI-jMsq.js";import{p as y}from"../chunks/Bxv1m9ax.js";import{s as Oe,b as O,a as H,d as Ae}from"../chunks/CN5En7F1.js";import{w as X}from"../chunks/4hlrb4d8.js";import{s as V,a as Pe}from"../chunks/BEUgLf7p.js";import{s as he}from"../chunks/CZQXRoan.js";import{b as Be}from"../chunks/Bs1xm8oX.js";import{e as Fe,i as Re}from"../chunks/B6FZq7_G.js";import{s as Ue,r as je}from"../chunks/CvOifuop.js";import{s as ne}from"../chunks/B9RedXCH.js";import{b as Je}from"../chunks/Dzbni-AY.js";import{C as Ye}from"../chunks/D7okP_CL.js";import{T as Xe}from"../chunks/Ct8AHqA9.js";var Ze=T("<canvas></canvas>");function ve(A,i){Q(i,!1);let d=y(i,"color",8),g=y(i,"size",8),l=y(i,"canvasStore",8),v=y(i,"disabled",8,!1),o=F(),t=F(),h=!1,r=null;fe(()=>{if(B(t,e(o).getContext("2d")),!e(t)){console.error("Failed to get 2D context");return}return console.log("Canvas bound:",!!e(o)),l()?l().set({canvas:e(o)}):console.warn("canvasStore not provided; canvas not stored"),p(),v()||b(),()=>{window.removeEventListener("resize",p),e(o).removeEventListener("touchstart",w),e(o).removeEventListener("touchmove",w),l()&&l().set({canvas:null})}});function p(){e(o)&&(x(o,e(o).width=window.innerWidth),x(o,e(o).height=window.innerHeight),m())}function m(){e(t)&&(x(t,e(t).fillStyle="white"),e(t).fillRect(0,0,e(o).width,e(o).height))}function w(a){a.preventDefault()}function b(){e(o).addEventListener("touchstart",w,{passive:!1}),e(o).addEventListener("touchmove",w,{passive:!1}),window.addEventListener("resize",p)}function M(a){const u=e(o).getBoundingClientRect();return"touches"in a?{x:a.touches[0].clientX-u.left,y:a.touches[0].clientY-u.top}:{x:a.offsetX,y:a.offsetY}}function R(a){v()||(a.preventDefault(),h=!0,r=M(a),r&&P(r.x,r.y))}function U(a){if(!h||!r||v())return;a.preventDefault();const u=r;r=M(a),e(t)&&(x(t,e(t).lineWidth=g()),x(t,e(t).lineCap="round"),x(t,e(t).strokeStyle=d()),e(t).beginPath(),e(t).moveTo(u.x,u.y),e(t).lineTo(r.x,r.y),e(t).stroke())}function I(a){v()||(a.preventDefault(),h=!1,r=null)}function P(a,u){e(t)&&(x(t,e(t).fillStyle=d()),e(t).beginPath(),e(t).arc(a,u,g()/2,0,Math.PI*2),e(t).fill())}Ee(()=>(e(t),ce(d()),ce(g())),()=>{e(t)&&(d()||g())&&(x(t,e(t).strokeStyle=d()),x(t,e(t).lineWidth=g()),x(t,e(t).fillStyle=d()))}),Le(),$();var f=Ze();let E;Be(f,a=>B(o,a),()=>e(o)),G(a=>E=he(f,1,"svelte-nqephp",null,E,a),[()=>({disabled:v()})],ge),C("pointerdown",f,R),C("pointermove",f,U),C("pointerup",f,I),C("pointerleave",f,I),D(A,f),K()}var We=T('<div class="controls svelte-yxtyn0"><button class="control-button svelte-yxtyn0" aria-label="Toggle menu"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svelte-yxtyn0"><circle cx="12" cy="12" r="1"></circle><circle cx="12" cy="5" r="1"></circle><circle cx="12" cy="19" r="1"></circle></svg></button> <button class="control-button svelte-yxtyn0" aria-label="Save drawing"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svelte-yxtyn0"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg></button> <button class="control-button svelte-yxtyn0" aria-label="Go back"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svelte-yxtyn0"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg></button></div>');function qe(A,i){Q(i,!1);let d=y(i,"onSave",8),g=y(i,"onMenuToggle",8),l=y(i,"canvasStore",8),v=null;l().subscribe(m=>{v=m.canvas,console.log("Canvas updated in DrawingControls:",!!v)});function o(){v?d()(v):console.error("Canvas not available")}$();var t=We(),h=z(t),r=_(h,2),p=_(r,2);k(t),C("click",h,function(...m){var w;(w=g())==null||w.apply(this,m)}),C("click",r,o),C("click",p,()=>window.history.back()),D(A,t),K()}var He=T("<button></button>"),Ve=T('<div class="advanced-options svelte-lhy0b3"><label class="option svelte-lhy0b3"><input type="checkbox"> Pressure Sensitivity</label> <label class="option svelte-lhy0b3"><input type="checkbox" checked> Smooth Strokes</label></div>'),Ge=T('<div class="menu svelte-lhy0b3"><div class="section svelte-lhy0b3"><h3 class="section-title svelte-lhy0b3">Colors</h3> <div class="color-grid svelte-lhy0b3"></div></div> <div class="section svelte-lhy0b3"><h3 class="section-title svelte-lhy0b3">Brush Size</h3> <div class="slider-container svelte-lhy0b3"><input type="range" min="1" max="50" class="size-slider svelte-lhy0b3"> <span class="size-value svelte-lhy0b3"> </span></div></div> <div class="section svelte-lhy0b3"><button class="advanced-toggle svelte-lhy0b3"> </button> <!></div></div>');function Qe(A,i){Q(i,!1);let d=y(i,"colors",8),g=y(i,"selected",8),l=y(i,"size",12),v=y(i,"onColorChange",8),o=y(i,"onSizeChange",8),t=F(!1);$();var h=Ge(),r=z(h),p=_(z(r),2);Fe(p,5,d,Re,(a,u)=>{var L=He();let W;G(ee=>{W=he(L,1,"color-button svelte-lhy0b3",null,W,ee),ne(L,`background-color: ${e(u)??""}`),Ue(L,"aria-label",e(u))},[()=>({selected:g()===e(u)})],ge),C("click",L,()=>v()(e(u))),D(a,L)}),k(p),k(r);var m=_(r,2),w=_(z(m),2),b=z(w);je(b);var M=_(b,2),R=z(M);k(M),k(w),k(m);var U=_(m,2),I=z(U),P=z(I,!0);k(I);var f=_(I,2);{var E=a=>{var u=Ve();D(a,u)};Z(f,a=>{e(t)&&a(E)})}k(U),k(h),G(()=>{ne(b,`--thumb-color: ${g()??""}`),ne(M,`color: ${g()??""}`),oe(R,`${l()??""}px`),oe(P,e(t)?"Hide Advanced":"Show Advanced")}),Je(b,l),C("input",b,()=>o()(l())),C("click",I,()=>B(t,!e(t))),D(A,h),K()}var Ke=T("<p>Loading...</p>"),$e=T("<p> </p>"),et=T("<!> <!> <!>",1),tt=T("<!> <!>",1);function _t(A,i){Q(i,!1);const[d,g]=Oe(),l=()=>H(r,"$sessionStore",d),v=()=>H(m,"$error",d),o=()=>H(p,"$loading",d),t=()=>H(b,"$toastState",d);let h=y(i,"data",8);const r=X(h().session),p=X(!0),m=X(null),w=X({canvas:null}),b=X({message:"",visible:!1,type:"success"}),M=["red","green","blue","black","white"],R="black",U=10,I=3e3;let P=F(R),f=F(U),E=F(!1),a=F(R),u=null,L;fe(async()=>{try{const{data:{session:s}}=await V.auth.getSession();O(r,s||h().session),u=await Pe();const{data:n}=V.auth.onAuthStateChange((c,S)=>{O(r,S)});return()=>{n.subscription.unsubscribe()}}catch(s){O(m,s instanceof Error?s.message:"Failed to load session")}finally{O(p,!1)}}),Ne(()=>{});const W=s=>s.split("@")[0]||"user";async function ee(s){try{const{count:n,error:c}=await V.from("drawings").select("*",{count:"exact",head:!0}).eq("user_id",s);if(c)throw c;return n||0}catch{return O(m,"Failed to fetch drawing count"),0}}async function pe(s,n){const c=W(s),S=await ee(n)+1;return`${c}-${S}`}async function me(s){var n;if(!s)return J("No canvas found","error");if(!((n=l())!=null&&n.user))return J("Please log in to save drawings","error");O(p,!0);try{await we();const c=await ye(s);await be(c),J("Drawing saved successfully!","success")}catch(c){_e(c)}finally{O(p,!1)}}async function we(){var c;const s=await fetch("/api/check-rate-limit",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:(c=l())==null?void 0:c.user.id})});if(!s.ok)throw new Error("Rate limit service unavailable");const n=await s.json();if(n.blocked)throw new Error(n.message||"You are temporarily banned");n.limited&&J(n.message||"Approaching submission limit","warning")}async function ye(s){const n=s.toDataURL("image/png"),c=new Date().toISOString(),S=await pe(l().user.email,l().user.id),{error:N}=await V.from("drawings").insert({id:crypto.randomUUID(),drawing_id:S,title:"Untitled",image_data:n,user_id:l().user.id,user_email:l().user.email,created_at:c,blocked:!1,likes:0,comments:{}});if(N)throw new Error("Failed to persist drawing");return S}async function be(s){try{const n="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBhYXB6dnNucnpzdWh0b3dtaWh6Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTczMzI2MzQ4MywiZXhwIjoyMDQ4ODM5NDgzfQ.ucVyxw_m53i9H12zFVIe6tbX5a-qWp1Fbr8u2HFrli8",c=await fetch("https://paapzvsnrzsuhtowmihz.supabase.co/functions/v1/send-push",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${n}`},body:JSON.stringify({title:"New Drawing Added!",body:`Your drawing '${s}' was saved!`,record:{id:s,user_id:l().user.id,user_email:l().user.email}})});if(c.ok)console.log("Notification sent successfully.");else{const S=await c.json();console.error("Notification failed:",S)}}catch(n){console.error("Error triggering notification:",n)}}function _e(s){const n=s instanceof Error?s.message:"Failed to save drawing";J(n,"error")}function J(s,n){clearTimeout(L),O(b,{message:s,visible:!0,type:n}),L=setTimeout(()=>{Ae(b,de(t).visible=!1,de(t))},I)}function Se(s){B(a,B(P,s))}function xe(s){B(f,Math.max(1,Math.min(50,s)))}function ke(){B(E,!e(E))}$();var re=tt(),ie=ue(re);{var Ce=s=>{var n=Ke();D(s,n)},Ie=(s,n)=>{{var c=N=>{var Y=$e(),te=z(Y);k(Y),G(()=>oe(te,`Error: ${v()??""}`)),D(N,Y)},S=(N,Y)=>{{var te=j=>{var q=et(),se=ue(q);ve(se,{get color(){return e(P)},get size(){return e(f)},canvasStore:w});var le=_(se,2);qe(le,{canvasStore:w,onSave:me,onMenuToggle:ke});var Te=_(le,2);{var Me=ae=>{Qe(ae,{colors:M,get selected(){return e(a)},get size(){return e(f)},onColorChange:Se,onSizeChange:xe})};Z(Te,ae=>{e(E)&&ae(Me)})}D(j,q)},De=j=>{Ye(j,{message:"You need to log in to start creating",children:(q,se)=>{ve(q,{get color(){return e(P)},get size(){return e(f)},disabled:!0})},$$slots:{default:!0}})};Z(N,j=>{l()?j(te):j(De,!1)},Y)}};Z(s,N=>{v()?N(c):N(S,!1)},n)}};Z(ie,s=>{o()?s(Ce):s(Ie,!1)})}var ze=_(ie,2);Xe(ze,{get message(){return t().message},get show(){return t().visible},get type(){return t().type}}),D(A,re),K(),g()}export{_t as component};
