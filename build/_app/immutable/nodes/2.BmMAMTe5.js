import"../chunks/CWj6FrbW.js";import"../chunks/69_IOA4Y.js";import{p as Me,an as je,ak as Je,ao as We,ap as oe,ar as l,x as e,G as p,a as De,A as t,at as m,au as v,aq as B,w as pe,az as Ie,aA as Ke,o as Qe,as as Xe}from"../chunks/CgpLTG9e.js";import{e as Q,r as Ye,s as j,h as Ze}from"../chunks/C_m-qMmZ.js";import{i as h}from"../chunks/ClXQIVwo.js";import{t as d,a as r,b as Ee,n as Le}from"../chunks/CVxkZOGS.js";import{s as Ve}from"../chunks/CvOifuop.js";import{s as le}from"../chunks/CZQXRoan.js";import{t as te,a as ne,f as Te}from"../chunks/sPbp32sz.js";import{i as Ne}from"../chunks/CKI-jMsq.js";import{s as Ue,a as Fe}from"../chunks/CN5En7F1.js";import{p as et}from"../chunks/Dhd2AGhS.js";import{C as tt}from"../chunks/D7okP_CL.js";import{A as qe}from"../chunks/7wuq7ABY.js";import{e as Pe,i as at}from"../chunks/B6FZq7_G.js";import{b as st}from"../chunks/Dzbni-AY.js";import{b as ot}from"../chunks/CeoSvVGI.js";import{p as rt}from"../chunks/Bxv1m9ax.js";import{s as se}from"../chunks/CZ_yMGco.js";import{u as it}from"../chunks/DtDuVMkV.js";import{g as he,i as Re}from"../chunks/DUphptMB.js";var lt=d('<div class="loading svelte-99wzd5"><div class="spinner svelte-99wzd5"></div></div>'),nt=d('<div class="error-message svelte-99wzd5" role="alert"> </div> <button class="retry-button svelte-99wzd5">Retry</button>',1),vt=d('<p class="no-comments svelte-99wzd5">No comments yet.</p>'),dt=d('<div class="spinner small svelte-99wzd5"></div>'),ct=d('<span class="heart svelte-99wzd5"> </span> ',1),mt=d('<div class="comment-item svelte-99wzd5"><div class="comment-header svelte-99wzd5"><span class="username svelte-99wzd5"> </span> <span class="timestamp svelte-99wzd5"> </span></div> <p class="comment-content svelte-99wzd5"> </p> <div class="comment-actions svelte-99wzd5"><button class="react-button svelte-99wzd5"><!></button> <button class="view-drawing svelte-99wzd5" aria-label="View drawing">View Drawing</button></div></div>'),ut=d('<div class="comment-list svelte-99wzd5"></div>'),gt=d('<option class="svelte-99wzd5"> </option>'),_t=d('<select class="svelte-99wzd5"><option disabled class="svelte-99wzd5">Select a drawing</option><!></select>'),ft=d('<p class="svelte-99wzd5">No drawings available to comment on.</p>'),pt=d('<div class="comment-form svelte-99wzd5"><!> <textarea placeholder="Add a comment..." rows="4" class="svelte-99wzd5"></textarea> <button class="comment-button svelte-99wzd5">Post Comment</button></div>'),ht=d('<p class="svelte-99wzd5">Please <button class="link-button svelte-99wzd5">log in</button> to post a comment or react.</p>'),wt=d('<div class="comment-modal-container svelte-99wzd5"><div class="modal svelte-99wzd5"><button class="close-button svelte-99wzd5" aria-label="Close comment modal"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" class="svelte-99wzd5"><path d="M18 6L6 18M6 6l12 12" stroke="white" stroke-width="2" stroke-linecap="round" class="svelte-99wzd5"></path></svg></button> <h2 class="svelte-99wzd5">Recent Comments</h2> <!> <!></div></div>'),bt=d("<!> <!>",1);function yt(we,ve){Me(ve,!1);const[be,ye]=Ue(),w=()=>Fe(it,"$user",be);let E=rt(ve,"show",12),C=p([]),P=p([]),_=p(""),V=p(""),$=p(!1),J=p(null),x=p(null),T=p(!1);function de(a){return w()&&w().id===a&&w().email?w().email.split("@")[0]:a.slice(0,8)}async function X(){var a;t($,!0),t(x,null);try{const{data:s,error:c}=await se.from("drawings").select("id, drawing_id").eq("blocked",!1).order("created_at",{ascending:!1});if(c)throw new Error(`Failed to load drawings: ${c.message}`);t(P,s.map(n=>({id:n.id,drawing_id:n.drawing_id}))),t(_,((a=e(P)[0])==null?void 0:a.drawing_id)||"");const{data:b,error:g}=await se.from("comments").select("id, drawing_id, user_id, content, created_at, display_name, reactions").order("created_at",{ascending:!1});if(g)throw new Error(`Failed to load comments: ${g.message}`);t(C,b.map(n=>({...n,display_name:n.display_name||de(n.user_id),reactions:Array.isArray(n.reactions)?n.reactions:[]}))),console.log("Fetched comments:",e(C))}catch(s){t(x,`Unexpected error loading comments: ${s.message}`),console.error("Unexpected error in fetchComments:",s),t(C,[]),t(P,[])}t($,!1)}async function ce(){var a;if(!w()||!e(V).trim()||!e(_)){t(x,"Please select a drawing and enter a comment");return}t($,!0),t(x,null);try{const s=e(P).find(g=>g.drawing_id===e(_));if(!s)throw new Error("Selected drawing not found");const c={drawing_id:s.id,user_id:w().id,content:e(V).trim(),display_name:((a=w().email)==null?void 0:a.split("@")[0])||w().id.slice(0,8)},{error:b}=await se.from("comments").insert([c]);if(b)throw new Error(`Failed to post comment: ${b.message}`);console.log("Comment posted successfully"),t(V,""),await X()}catch(s){t(x,`Error posting comment: ${s.message}`),console.error("Error posting comment:",s)}t($,!1)}async function me(a){if(!w()){localStorage.setItem("sb-redirect",window.location.pathname),t(T,!0);return}t(J,a),t(x,null);try{const s=e(C).find(n=>n.id===a);if(!s)throw new Error("Comment not found");const c=s.reactions.some(n=>n.user_id===w().id);let b;c?b=s.reactions.filter(n=>n.user_id!==w().id):b=[...s.reactions,{user_id:w().id,created_at:new Date().toISOString()}];const{error:g}=await se.from("comments").update({reactions:b}).eq("id",a);if(g)throw new Error(`Failed to update reactions: ${g.message}`);t(C,e(C).map(n=>n.id===a?{...n,reactions:b}:n)),console.log("Reaction updated successfully")}catch(s){t(x,`Failed to react to comment: ${s.message}`),console.error("Reaction error:",s)}finally{t(J,null)}}function ke(a){if(!a||typeof a!="string"||a.trim()===""){console.error("Invalid drawingId:",a),t(x,"Cannot navigate: Invalid drawing ID");return}console.log("Navigating to drawing:",a),he(`/gallery/${a}`),E(!1)}function ze(){console.log("Login prompt triggered"),localStorage.setItem("sb-redirect",window.location.pathname),t(T,!0)}je(()=>Je(E()),()=>{E()&&(console.log("Comments modal opened, fetching comments"),X())}),We(),Ne();var re=bt(),ue=oe(re);{var xe=a=>{var s=wt(),c=m(s),b=m(c),g=l(b,4);{var n=k=>{var S=lt();r(k,S)},Y=(k,S)=>{{var H=N=>{var M=nt(),U=oe(M),y=m(U,!0);v(U);var f=l(U,2);B(()=>j(y,e(x))),Q("click",f,X),r(N,M)},ae=(N,M)=>{{var U=f=>{var D=vt();r(f,D)},y=f=>{var D=ut();Pe(D,5,()=>e(C),Z=>Z.id,(Z,z)=>{var G=mt(),o=m(G),i=m(o),A=m(i,!0);v(i);var F=l(i,2),W=m(F,!0);v(F),v(o);var ee=l(o,2),q=m(ee,!0);v(ee);var O=l(ee,2),K=m(O),I=m(K);{var ie=R=>{var L=dt();r(R,L)},Be=R=>{var L=ct(),$e=oe(L),Ge=m($e,!0);v($e);var Oe=l($e);B(Se=>{j(Ge,Se),j(Oe,` ${e(z).reactions.length??""}`)},[()=>e(z).reactions.some(Se=>{var Ae;return Se.user_id===((Ae=w())==null?void 0:Ae.id)})?"❤️":"🤍"],pe),r(R,L)};h(I,R=>{e(J)===e(z).id?R(ie):R(Be,!1)})}v(K);var He=l(K,2);v(O),v(G),B((R,L)=>{j(A,e(z).display_name||"Anonymous"),j(W,R),j(q,e(z).content),K.disabled=e(J)===e(z).id,Ve(K,"aria-label",L)},[()=>new Date(e(z).created_at).toLocaleString(),()=>e(z).reactions.some(R=>{var L;return R.user_id===((L=w())==null?void 0:L.id)})?"Unlike comment":"Like comment"],pe),Q("click",K,()=>me(e(z).id)),Q("click",He,()=>{var R;return ke(((R=e(P).find(L=>L.id===e(z).drawing_id))==null?void 0:R.drawing_id)||"")}),r(Z,G)}),v(D),r(f,D)};h(N,f=>{e(C).length===0?f(U):f(y,!1)},M)}};h(k,N=>{e(x)?N(H):N(ae,!1)},S)}};h(g,k=>{e($)?k(n):k(Y,!1)})}var ge=l(g,2);{var _e=k=>{var S=pt(),H=m(S);{var ae=y=>{var f=_t();B(()=>{e(_),Ke(()=>{e($),e(P)})});var D=m(f);D.value=D.__value="";var Z=l(D);Pe(Z,1,()=>e(P),at,(z,G)=>{var o=gt(),i={},A=m(o);v(o),B(()=>{i!==(i=e(G).drawing_id)&&(o.value=(o.__value=e(G).drawing_id)??""),j(A,`Drawing #${e(G).drawing_id??""}`)}),r(z,o)}),v(f),B(()=>f.disabled=e($)),ot(f,()=>e(_),z=>t(_,z)),r(y,f)},N=y=>{var f=ft();r(y,f)};h(H,y=>{e(P).length>0?y(ae):y(N,!1)})}var M=l(H,2);Ye(M);var U=l(M,2);v(S),B(y=>{M.disabled=e($)||e(P).length===0,U.disabled=y},[()=>e($)||!e(V).trim()||!e(_)],pe),st(M,()=>e(V),y=>t(V,y)),Q("click",U,ce),r(k,S)},fe=k=>{var S=ht(),H=l(m(S));Ie(),v(S),Q("click",H,ze),r(k,S)};h(ge,k=>{w()?k(_e):k(fe,!1)})}v(c),v(s),Q("click",b,()=>{console.log("Close comment modal clicked"),E(!1),t(x,null)}),te(3,c,()=>ne,()=>({y:100,duration:400})),te(3,s,()=>Te,()=>({duration:300})),r(a,s)};h(ue,a=>{E()&&a(xe)})}var Ce=l(ue,2);{var u=a=>{qe(a,{get show(){return e(T)},set show(s){t(T,s)},$$events:{authSuccess:()=>{console.log("Auth success, refreshing comments"),t(T,!1),X()},authError:({detail:s})=>{console.log("Auth error:",s.message),t(x,s.message),t(T,!1)}},$$legacy:!0})};h(Ce,a=>{e(T)&&a(u)})}r(we,re),De(),ye()}var kt=d('<meta name="description" content="A collaborative creative platform for drawing, plotting, selling, and solving challenges." class="svelte-i1vkni">'),zt=d('<div class="loader-container svelte-i1vkni" role="status" aria-live="polite"><div class="loader-overlay svelte-i1vkni"></div> <div class="loader-content svelte-i1vkni"><img src="/logo192.png" alt="Pexos Logo" class="loader-logo floating svelte-i1vkni"> <p class="loader-text svelte-i1vkni">Initializing Pexos...</p></div></div>'),xt=d('<div class="svelte-i1vkni"><img src="/logo192.png" alt="Pexos Logo" class="hero-logo svelte-i1vkni"></div>'),Ct=d('<div class="svelte-i1vkni"><h1 class="hero-title svelte-i1vkni">Pexos</h1></div>'),$t=d('<div class="svelte-i1vkni"><p class="hero-subtitle svelte-i1vkni">A Collaborative Creative Platform</p></div>'),St=d('<div class="headline-section svelte-i1vkni"><h2 class="hero-headline svelte-i1vkni"><!> Create, Plot, Sell, and Solve Community Challenges</h2></div>'),At=Le('<path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z" fill="white" class="svelte-i1vkni"></path>'),Et=Le('<path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm4.59-12.42L10 14.17l-2.59-2.58L6 13l4 4 8-8z" fill="white" class="svelte-i1vkni"></path>'),Pt=d('<div class="svelte-i1vkni"><button class="action-button svelte-i1vkni"><span class="button-icon svelte-i1vkni"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" class="svelte-i1vkni"><!></svg></span> </button></div>'),Rt=d('<div class="hero-container svelte-i1vkni"><div><!></div> <div></div> <div></div> <div></div> <div></div> <div class="hero-content svelte-i1vkni"><!> <!> <!> <!> <!></div></div>'),Mt=d('<div class="modal-debug svelte-i1vkni">Auth Modal should be visible</div> <!>',1),Dt=d('<div class="modal-debug svelte-i1vkni">Comment Modal should be visible</div> <!>',1),It=d("<!> <!> <!>",1);function aa(we,ve){Me(ve,!1);const[be,ye]=Ue(),w=()=>Fe(et,"$page",be);let E=p(!1),C=p(!1),P=p(!0),_=p(null),V=p(!1),$=p(!1),J=p(!1),x=p(!1),T=p(!1),de=p(!1);Qe(async()=>{console.log("Root page mounted");try{const{data:{session:u},error:a}=await se.auth.getSession();a&&console.error("Session check error:",a.message),t(_,u),console.log("Initial session:",e(_)?"User logged in":"No user"),setTimeout(()=>{t(P,!1),setTimeout(()=>t(V,!0),300),setTimeout(()=>t($,!0),800),setTimeout(()=>t(J,!0),1300),setTimeout(()=>t(x,!0),1800),setTimeout(()=>t(T,!0),2200),setTimeout(()=>t(de,!0),2800)},1e3);const s=w().url.searchParams.get("redirect");s&&(console.log("Redirect param:",s),localStorage.setItem("sb-redirect",decodeURIComponent(s)),e(_)?(console.log("User already signed in, redirecting to:",s),he(decodeURIComponent(s),{replaceState:!0})):(console.log("No session, showing auth modal"),t(E,!0)));const{data:c}=se.auth.onAuthStateChange(async(b,g)=>{var n;if(console.log("Auth state changed:",b,(n=g==null?void 0:g.user)==null?void 0:n.email),t(_,g),b==="SIGNED_IN"&&g){await Re();const Y=localStorage.getItem("sb-redirect")||"/";localStorage.removeItem("sb-redirect"),console.log("Redirecting after sign-in:",Y),he(Y,{replaceState:!0})}});return()=>c.subscription.unsubscribe()}catch(u){console.error("Session check failed:",u),t(P,!1)}});function X(){e(_)?(console.log("User logged in, toggling comment modal"),t(C,!0)):(console.log("No user, showing auth modal"),t(E,!0)),console.log("Modal states:",{showAuthModal:e(E),showCommentModal:e(C)})}Ne();var ce=It();Ze(u=>{var a=kt();Xe.title="Pexos - Creative Platform",r(u,a)});var me=oe(ce);{var ke=u=>{var a=zt();r(u,a)},ze=u=>{var a=Rt(),s=m(a);let c;var b=m(s);tt(b,{}),v(s);var g=l(s,2);let n;var Y=l(g,2);let ge;var _e=l(Y,2);let fe;var k=l(_e,2);let S;var H=l(k,2),ae=m(H);{var N=o=>{var i=xt();te(1,i,()=>ne,()=>({y:50,duration:1e3})),r(o,i)};h(ae,o=>{e(J)&&o(N)})}var M=l(ae,2);{var U=o=>{var i=Ct();te(1,i,()=>ne,()=>({y:50,duration:1e3,delay:200})),r(o,i)};h(M,o=>{e(J)&&o(U)})}var y=l(M,2);{var f=o=>{var i=$t();te(1,i,()=>ne,()=>({y:30,duration:800,delay:300})),r(o,i)};h(y,o=>{e(x)&&o(f)})}var D=l(y,2);{var Z=o=>{var i=St(),A=m(i),F=m(A);{var W=q=>{var O=Ee();B(()=>j(O,`Welcome back, ${e(_).user.email??""}!`)),r(q,O)},ee=q=>{var O=Ee("Join the Pexos community and unleash your creativity!");r(q,O)};h(F,q=>{e(_)?q(W):q(ee,!1)})}Ie(),v(A),v(i),te(1,i,()=>ne,()=>({x:-100,duration:1e3,delay:400})),r(o,i)};h(D,o=>{e(T)&&o(Z)})}var z=l(D,2);{var G=o=>{var i=Pt(),A=m(i),F=m(A),W=m(F),ee=m(W);{var q=I=>{var ie=At();r(I,ie)},O=I=>{var ie=Et();r(I,ie)};h(ee,I=>{e(_)?I(q):I(O,!1)})}v(W),v(F);var K=l(F);v(A),v(i),B(()=>{Ve(A,"aria-label",e(_)?"View comments":"Sign in to Pexos"),j(K,` ${e(_)?"View Comments":"Sign In"}`)}),Q("click",A,X),Q("keydown",A,I=>(I.key==="Enter"||I.key==="Space")&&X()),te(1,i,()=>Te,()=>({duration:800,delay:500})),r(o,i)};h(z,o=>{e(de)&&o(G)})}v(H),v(a),B((o,i,A,F,W)=>{c=le(s,1,"shader-layer svelte-i1vkni",null,c,o),n=le(g,1,"overlay-layer svelte-i1vkni",null,n,i),ge=le(Y,1,"deco-element top-right svelte-i1vkni",null,ge,A),fe=le(_e,1,"deco-element bottom-left svelte-i1vkni",null,fe,F),S=le(k,1,"deco-element center-glow svelte-i1vkni",null,S,W)},[()=>({active:e(V)}),()=>({"fade-out":e(V)}),()=>({visible:e($)}),()=>({visible:e($)}),()=>({visible:e($)})],pe),r(u,a)};h(me,u=>{e(P)?u(ke):u(ze,!1)})}var re=l(me,2);{var ue=u=>{var a=Mt(),s=l(oe(a),2);qe(s,{get show(){return e(E)},set show(c){t(E,c)},$$events:{authSuccess:async()=>{console.log("Auth success event"),await Re();const c=localStorage.getItem("sb-redirect")||"/";localStorage.removeItem("sb-redirect"),console.log("Redirecting after auth success:",c),he(c,{replaceState:!0})},authError:({detail:c})=>{console.log("Auth error:",c.message),t(E,!1)}},$$legacy:!0}),r(u,a)};h(re,u=>{e(E)&&u(ue)})}var xe=l(re,2);{var Ce=u=>{var a=Dt(),s=l(oe(a),2);yt(s,{get show(){return e(C)},set show(c){t(C,c)},$$legacy:!0}),r(u,a)};h(xe,u=>{e(C)&&u(Ce)})}r(we,ce),De(),ye()}export{aa as component};
