import{t as E,a as x,c as Le}from"../chunks/DxolCNix.js";import"../chunks/Ci8d3Fat.js";import{p as Q,o as he,A as R,x as e,I as j,am as D,ao as Ie,ak as de,ap as qe,aq as X,w as ie,a as $,as as z,ar as C,at as S,av as ne,aW as Ae,u as fe}from"../chunks/B668RH8u.js";import{e as T,s as K}from"../chunks/DhXqswRN.js";import{i as W}from"../chunks/CoxfEDN7.js";import{i as ee}from"../chunks/CHu_v1B0.js";import{p as h}from"../chunks/BfDDsPvW.js";import{s as Me,b as P,a as V,d as Pe}from"../chunks/BHuW5wU9.js";import{w as H}from"../chunks/CxeLWBhm.js";import{s as Z,a as Oe}from"../chunks/AJiKPocd.js";import{s as le}from"../chunks/BavnsP6q.js";import{b as Re}from"../chunks/DF75DhTM.js";import{e as je,i as Be}from"../chunks/Dxuc275j.js";import{a as Fe,r as Ne}from"../chunks/DGKrTPFL.js";import{s as re}from"../chunks/kt7n16z5.js";import{b as We}from"../chunks/AOsgo3jW.js";import{C as Ue}from"../chunks/Cisl1x4j.js";import{t as Ye,a as He}from"../chunks/CfWLuewf.js";var Xe=E("<canvas></canvas>");function ge(L,i){Q(i,!1);let v=h(i,"color",8),m=h(i,"size",8),l=h(i,"canvasStore",8),c=h(i,"disabled",8,!1),n=j(),t=j(),d=!1,o=null;he(()=>{if(R(t,e(n).getContext("2d")),!e(t)){console.error("Failed to get 2D context");return}return console.log("Canvas bound:",!!e(n)),l()?l().set({canvas:e(n)}):console.warn("canvasStore not provided; canvas not stored"),g(),c()||k(),()=>{window.removeEventListener("resize",g),e(n).removeEventListener("touchstart",b),e(n).removeEventListener("touchmove",b),l()&&l().set({canvas:null})}});function g(){e(n)&&(D(n,e(n).width=window.innerWidth),D(n,e(n).height=window.innerHeight),p())}function p(){e(t)&&(D(t,e(t).fillStyle="white"),e(t).fillRect(0,0,e(n).width,e(n).height))}function b(a){a.preventDefault()}function k(){e(n).addEventListener("touchstart",b,{passive:!1}),e(n).addEventListener("touchmove",b,{passive:!1}),window.addEventListener("resize",g)}function q(a){const f=e(n).getBoundingClientRect();return"touches"in a?{x:a.touches[0].clientX-f.left,y:a.touches[0].clientY-f.top}:{x:a.offsetX,y:a.offsetY}}function B(a){c()||(a.preventDefault(),d=!0,o=q(a),o&&O(o.x,o.y))}function F(a){if(!d||!o||c())return;a.preventDefault();const f=o;o=q(a),e(t)&&(D(t,e(t).lineWidth=m()),D(t,e(t).lineCap="round"),D(t,e(t).strokeStyle=v()),e(t).beginPath(),e(t).moveTo(f.x,f.y),e(t).lineTo(o.x,o.y),e(t).stroke())}function I(a){c()||(a.preventDefault(),d=!1,o=null)}function O(a,f){e(t)&&(D(t,e(t).fillStyle=v()),e(t).beginPath(),e(t).arc(a,f,m()/2,0,Math.PI*2),e(t).fill())}Ie(()=>(e(t),de(v()),de(m())),()=>{e(t)&&(v()||m())&&(D(t,e(t).strokeStyle=v()),D(t,e(t).lineWidth=m()),D(t,e(t).fillStyle=v()))}),qe(),ee();var y=Xe();let A;Re(y,a=>R(n,a),()=>e(n)),X(a=>A=le(y,1,"svelte-nqephp",null,A,a),[()=>({disabled:c()})],ie),T("pointerdown",y,B),T("pointermove",y,F),T("pointerup",y,I),T("pointerleave",y,I),x(L,y),$()}var Ge=E('<div class="controls svelte-kd1b1q"><button class="control-button svelte-kd1b1q" aria-label="Toggle menu"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svelte-kd1b1q"><circle cx="12" cy="12" r="1"></circle><circle cx="12" cy="5" r="1"></circle><circle cx="12" cy="19" r="1"></circle></svg></button> <button class="control-button svelte-kd1b1q" aria-label="Save drawing"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svelte-kd1b1q"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg></button> <button class="control-button svelte-kd1b1q" aria-label="Go back"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svelte-kd1b1q"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg></button></div>');function Je(L,i){Q(i,!1);let v=h(i,"onSave",8),m=h(i,"onMenuToggle",8),l=h(i,"canvasStore",8),c=null;l().subscribe(p=>{c=p.canvas,console.log("Canvas updated in DrawingControls:",!!c)});function n(){c?v()(c):console.error("Canvas not available")}ee();var t=Ge(),d=z(t),o=C(d,2),g=C(o,2);S(t),T("click",d,function(...p){var b;(b=m())==null||b.apply(this,p)}),T("click",o,n),T("click",g,()=>window.history.back()),x(L,t),$()}var Ve=E("<button></button>"),Ze=E('<div class="advanced-options svelte-lhy0b3"><label class="option svelte-lhy0b3"><input type="checkbox"> Pressure Sensitivity</label> <label class="option svelte-lhy0b3"><input type="checkbox" checked> Smooth Strokes</label></div>'),Ke=E('<div class="menu svelte-lhy0b3"><div class="section svelte-lhy0b3"><h3 class="section-title svelte-lhy0b3">Colors</h3> <div class="color-grid svelte-lhy0b3"></div></div> <div class="section svelte-lhy0b3"><h3 class="section-title svelte-lhy0b3">Brush Size</h3> <div class="slider-container svelte-lhy0b3"><input type="range" min="1" max="50" class="size-slider svelte-lhy0b3"> <span class="size-value svelte-lhy0b3"> </span></div></div> <div class="section svelte-lhy0b3"><button class="advanced-toggle svelte-lhy0b3"> </button> <!></div></div>');function Qe(L,i){Q(i,!1);let v=h(i,"colors",8),m=h(i,"selected",8),l=h(i,"size",12),c=h(i,"onColorChange",8),n=h(i,"onSizeChange",8),t=j(!1);ee();var d=Ke(),o=z(d),g=C(z(o),2);je(g,5,v,Be,(a,f)=>{var M=Ve();let G;X(te=>{G=le(M,1,"color-button svelte-lhy0b3",null,G,te),re(M,`background-color: ${e(f)??""}`),Fe(M,"aria-label",e(f))},[()=>({selected:m()===e(f)})],ie),T("click",M,()=>c()(e(f))),x(a,M)}),S(g),S(o);var p=C(o,2),b=C(z(p),2),k=z(b);Ne(k);var q=C(k,2),B=z(q);S(q),S(b),S(p);var F=C(p,2),I=z(F),O=z(I,!0);S(I);var y=C(I,2);{var A=a=>{var f=Ze();x(a,f)};W(y,a=>{e(t)&&a(A)})}S(F),S(d),X(()=>{re(k,`--thumb-color: ${m()??""}`),re(q,`color: ${m()??""}`),K(B,`${l()??""}px`),K(O,e(t)?"Hide Advanced":"Show Advanced")}),We(k,l),T("input",k,()=>n()(l())),T("click",I,()=>R(t,!e(t))),x(L,d),$()}var $e=E("<div> </div>");function et(L,i){let v=h(i,"message",8),m=h(i,"show",8),l=h(i,"type",8,"success");var c=Le(),n=ne(c);{var t=d=>{var o=$e();let g;var p=z(o,!0);S(o),X(b=>{g=le(o,1,"toast svelte-1q32h6p",null,g,b),K(p,v())},[()=>({success:l()==="success",error:l()==="error"})],ie),Ye(3,o,()=>He,()=>({duration:300})),x(d,o)};W(n,d=>{m()&&d(t)})}x(L,c)}var tt=E("<p>Loading...</p>"),st=E("<p> </p>"),at=E("<!> <!> <!>",1),ot=E("<!> <!>",1);function St(L,i){Q(i,!1);const[v,m]=Me(),l=()=>V(o,"$sessionStore",v),c=()=>V(p,"$error",v),n=()=>V(g,"$loading",v),t=()=>V(k,"$toastState",v);let d=h(i,"data",8);const o=H(d().session),g=H(!0),p=H(null),b=H({canvas:null}),k=H({message:"",visible:!1,type:"success"}),q=["red","green","blue","black","white"],B="black",F=10,I=3e3;let O=j(B),y=j(F),A=j(!1),a=j(B),f=null,M;he(async()=>{try{const{data:{session:s}}=await Z.auth.getSession();P(o,s||d().session),f=await Oe(),console.log("Create page user:",f),console.log("Create page session:",l()),console.log("Client cookies:",document.cookie);const{data:r}=Z.auth.onAuthStateChange((u,w)=>{var _;console.log("Auth state changed:",u,(_=w==null?void 0:w.user)==null?void 0:_.email),P(o,w)});return()=>{r.subscription.unsubscribe()}}catch(s){P(p,s instanceof Error?s.message:"Failed to load session"),console.error("Session sync error:",s)}finally{P(g,!1)}}),Ae(()=>{});const G=s=>s.split("@")[0]||"user";async function te(s){try{const{count:r,error:u}=await Z.from("drawings").select("*",{count:"exact",head:!0}).eq("user_id",s);if(u)throw u;return r||0}catch(r){return console.error("Error fetching drawing count:",r),P(p,"Failed to fetch drawing count"),0}}async function me(s,r){const u=G(s),w=await te(r)+1;return`${u}-${w}`}async function pe(s){var r;if(!s){U("No canvas element found","error");return}if(!((r=l())!=null&&r.user)){U("Please login to save drawings","error");return}P(g,!0);try{await be(),await we(s),U("Drawing saved successfully!","success")}catch(u){ye(u)}finally{P(g,!1)}}async function be(){var s,r;try{console.log("Fetching rate limit check for user:",(s=l())==null?void 0:s.user.id);const u=await fetch("/api/check-rate-limit",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:(r=l())==null?void 0:r.user.id})});if(!u.ok)throw new Error("Rate limit service unavailable");const w=await u.json();if(w.blocked)throw new Error(w.message||"You are temporarily banned due to excessive submissions");w.limited&&U(w.message||"Warning: approaching submission limit","warning")}catch(u){throw console.error("[Rate Limit]",u),u}}async function we(s){try{const r=s.toDataURL("image/png"),u=new Date().toISOString(),w=await me(l().user.email,l().user.id),{error:_}=await Z.from("drawings").insert({drawing_id:w,image_data:r,user_id:l().user.id,user_email:l().user.email,created_at:u,blocked:!1,likes:0,comments:{}});if(_)throw _}catch(r){throw console.error("[Supabase] Persist error:",r),r}}function ye(s){const r=s instanceof Error?s.message:"Failed to save drawing";console.error("[DrawingApp] Save error:",s),U(r,"error")}function U(s,r){clearTimeout(M),P(k,{message:s,visible:!0,type:r}),M=setTimeout(()=>{Pe(k,fe(t).visible=!1,fe(t))},I)}function _e(s){R(a,R(O,s))}function ke(s){R(y,Math.max(1,Math.min(50,s)))}function Se(){R(A,!e(A))}ee();var ce=ot(),ue=ne(ce);{var Ce=s=>{var r=tt();x(s,r)},xe=(s,r)=>{{var u=_=>{var Y=st(),se=z(Y);S(Y),X(()=>K(se,`Error: ${c()??""}`)),x(_,Y)},w=(_,Y)=>{{var se=N=>{var J=at(),ae=ne(J);ge(ae,{get color(){return e(O)},get size(){return e(y)},canvasStore:b});var ve=C(ae,2);Je(ve,{canvasStore:b,onSave:pe,onMenuToggle:Se});var Te=C(ve,2);{var Ee=oe=>{Qe(oe,{colors:q,get selected(){return e(a)},get size(){return e(y)},onColorChange:_e,onSizeChange:ke})};W(Te,oe=>{e(A)&&oe(Ee)})}x(N,J)},ze=N=>{Ue(N,{message:"You need to log in to start creating",children:(J,ae)=>{ge(J,{get color(){return e(O)},get size(){return e(y)},disabled:!0})},$$slots:{default:!0}})};W(_,N=>{l()?N(se):N(ze,!1)},Y)}};W(s,_=>{c()?_(u):_(w,!1)},r)}};W(ue,s=>{n()?s(Ce):s(xe,!1)})}var De=C(ue,2);et(De,{get message(){return t().message},get show(){return t().visible},get type(){return t().type}}),x(L,ce),$(),m()}export{St as component};
