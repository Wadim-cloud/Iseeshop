import"./CWj6FrbW.js";import"./69_IOA4Y.js";import{a1 as _e,p as ge,A as a,G as U,o as be,ap as Y,at as c,ar as d,au as i,x as s,aq as L,a as he,w as Z,az as we}from"./CgpLTG9e.js";import{s as k,e as y,r as ye}from"./C_m-qMmZ.js";import{i as E}from"./ClXQIVwo.js";import{e as Ce}from"./B6FZq7_G.js";import{t as f,a as p}from"./CVxkZOGS.js";import{b as xe}from"./Dzbni-AY.js";import{s as Ue}from"./Bfc47y5P.js";import{i as ke}from"./CKI-jMsq.js";import{p as R}from"./Bxv1m9ax.js";import{a as Ee,s as Me}from"./CN5En7F1.js";import{s as ee}from"./BX0sDDBR.js";import{u as De}from"./BwLfIDK9.js";import{A as Ie}from"./vL3NiHFz.js";function Ae(P,v){var r;var g=(r=P.$$events)==null?void 0:r[v.type],q=_e(g)?g.slice():g==null?[]:[g];for(var n of q)n.call(this,v)}var Fe=f("<p>Loading comments...</p>"),Le=f('<p class="error svelte-10mb2nl"> </p> <button class="retry-button svelte-10mb2nl">Retry</button>',1),Pe=f("<p>No comments yet. Be the first to comment!</p>"),qe=f('<div class="comment svelte-10mb2nl"><p class="svelte-10mb2nl"><strong class="username svelte-10mb2nl"> </strong> </p> <small class="svelte-10mb2nl"> </small></div>'),Se=f('<div class="comments-list svelte-10mb2nl"></div>'),$e=f('<div class="comment-form svelte-10mb2nl"><textarea placeholder="Add a comment..." rows="4" class="svelte-10mb2nl"></textarea> <button class="comment-button svelte-10mb2nl">Post Comment</button></div>'),ze=f('<p>Please <button class="link-button svelte-10mb2nl">log in</button> to post a comment.</p>'),Ne=f('<div class="modal-overlay svelte-10mb2nl"><div class="modal-content svelte-10mb2nl"><button class="close-button svelte-10mb2nl">Ã—</button> <h2 class="svelte-10mb2nl"> </h2> <!> <!></div></div> <!>',1);function et(P,v){var T,V,W;ge(v,!1);const[g,q]=Me(),n=()=>Ee(De,"$user",g);let r=R(v,"id",8),M=R(v,"drawing_id",8),H=R(v,"onClose",8),b=U([]),h=U(""),_=U(!1),l=U(null),w=U(!1);!r()||!M()?(a(l,"Invalid drawing ID or UUID"),console.error("CommentsModal mounted with invalid props:",{id:r(),drawing_id:M()})):console.log("CommentsModal mounted with props:",{id:r(),drawing_id:M(),idLength:(T=r())==null?void 0:T.length,userId:(V=n())==null?void 0:V.id,userEmail:(W=n())==null?void 0:W.email});function te(e){return n()&&n().id===e&&n().email?n().email.split("@")[0]:e.slice(0,8)}async function D(){if(!r()){a(l,"Cannot load comments: Missing drawing UUID"),console.error("fetchComments called with invalid id:",r());return}a(_,!0),a(l,null),console.log("Fetching comments for UUID:",r());try{const{data:e,error:t}=await ee.from("comments").select("id, user_id, content, created_at, display_name").eq("drawing_id",r()).order("created_at",{ascending:!1});t?(a(l,`Failed to load comments: ${t.message}`),console.error("Error fetching comments:",t),a(b,[])):(a(b,e.map(o=>({...o,display_name:o.display_name||te(o.user_id)}))),console.log("Fetched comments:",s(b)))}catch(e){a(l,`Unexpected error loading comments: ${e.message}`),console.error("Unexpected error in fetchComments:",e),a(b,[])}a(_,!1)}async function ae(){var e;if(!(!n()||!s(h).trim())){if(!r()){a(l,"Cannot post comment: Missing drawing UUID"),console.error("postComment called with invalid id:",r());return}a(_,!0),a(l,null);try{const t={drawing_id:r(),user_id:n().id,content:s(h).trim(),display_name:((e=n().email)==null?void 0:e.split("@")[0])||n().id.slice(0,8)},{error:o}=await ee.from("comments").insert([t]);if(o)throw new Error(`Failed to post comment: ${o.message}`);console.log("Comment posted successfully"),a(h,""),await D()}catch(t){a(l,`Error: ${t.message}`),console.error("Error posting comment:",t)}a(_,!1)}}function oe(){localStorage.setItem("sb-redirect",window.location.pathname),a(w,!0)}be(()=>{var e,t;console.log("CommentsModal mounted. Authenticated user ID:",(e=n())==null?void 0:e.id,"Email:",(t=n())==null?void 0:t.email),r()?D().catch(o=>{console.error("Error in onMount fetchComments:",o),a(l,`Failed to initialize comments: ${o.message}`)}):console.error("onMount skipped due to invalid id:",r())}),ke();var J=Ne(),I=Y(J),S=c(I),K=c(S),$=d(K,2),se=c($);i($);var Q=d($,2);{var re=e=>{var t=Fe();p(e,t)},ne=(e,t)=>{{var o=m=>{var F=Le(),C=Y(F),z=c(C,!0);i(C);var u=d(C,2);L(()=>k(z,s(l))),y("click",u,D),p(m,F)},A=(m,F)=>{{var C=u=>{var x=Pe();p(u,x)},z=u=>{var x=Se();Ce(x,5,()=>s(b),N=>N.id,(N,j)=>{var B=qe(),G=c(B),O=c(G),ve=c(O,!0);i(O);var ue=d(O);i(G);var X=d(G,2),pe=c(X,!0);i(X),i(B),L(fe=>{k(ve,s(j).display_name||"User"),k(ue,`: ${s(j).content??""}`),k(pe,fe)},[()=>new Date(s(j).created_at).toLocaleString()],Z),p(N,B)}),i(x),p(u,x)};E(m,u=>{s(b).length===0?u(C):u(z,!1)},F)}};E(e,m=>{s(l)?m(o):m(A,!1)},t)}};E(Q,e=>{s(_)?e(re):e(ne,!1)})}var le=d(Q,2);{var ie=e=>{var t=$e(),o=c(t);ye(o);var A=d(o,2);i(t),L(m=>{o.disabled=s(_),A.disabled=m},[()=>s(_)||!s(h).trim()],Z),xe(o,()=>s(h),m=>a(h,m)),y("click",A,ae),p(e,t)},me=e=>{var t=ze(),o=d(c(t));we(),i(t),y("click",o,oe),p(e,t)};E(le,e=>{n()?e(ie):e(me,!1)})}i(S),i(I);var ce=d(I,2);{var de=e=>{Ie(e,{get show(){return s(w)},set show(t){a(w,t)},$$events:{authSuccess:()=>{a(w,!1),D()},authError:({detail:t})=>{a(l,t.message),a(w,!1)}},$$legacy:!0})};E(ce,e=>{s(w)&&e(de)})}L(()=>k(se,`Comments for Drawing #${M()||"Unknown"}`)),y("click",K,function(...e){var t;(t=H())==null||t.apply(this,e)}),y("click",S,Ue(function(e){Ae.call(this,v,e)})),y("click",I,function(...e){var t;(t=H())==null||t.apply(this,e)}),p(P,J),he(),q()}export{et as C};
